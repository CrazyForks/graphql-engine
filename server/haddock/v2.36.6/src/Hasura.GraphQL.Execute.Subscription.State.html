<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Top-level management of subscription poller threads.</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- The implementation of the polling itself is</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- in &quot;Hasura.GraphQL.Execute.Subscription.Poll&quot;. See &quot;Hasura.GraphQL.Execute.Subscription&quot; for high-level</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- details.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.State</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier">SubscriptionsState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#initSubscriptionsState"><span class="hs-identifier">initSubscriptionsState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#dumpSubscriptionsState"><span class="hs-identifier">dumpSubscriptionsState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier">SubscriberDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier">SubscriptionPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addLiveQuery"><span class="hs-identifier">addLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addStreamSubscriptionQuery"><span class="hs-identifier">addStreamSubscriptionQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeLiveQuery"><span class="hs-identifier">removeLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeStreamingQuery"><span class="hs-identifier">removeStreamingQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier">LiveAsyncActionQueryOnSource</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier">LiveAsyncActionQueryWithNoRelationships</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQuery"><span class="hs-identifier">LiveAsyncActionQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionQueryLive"><span class="hs-identifier">AsyncActionQueryLive</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionSubscriptionState"><span class="hs-identifier">AsyncActionSubscriptionState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addAsyncActionLiveQuery"><span class="hs-identifier">addAsyncActionLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier">removeAsyncActionLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier">LiveQuerySubscriberDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#StreamingSubscriberDetails"><span class="hs-identifier">StreamingSubscriberDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">where</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier">forkImmortal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/immortal-0.2.2.1-e3bd4e0e64dc114baa3abc247b1e60df834aa7935cf82aff7a3976b9f7bb0e91/share/doc/html/src/Control.Immortal.html"><span class="hs-identifier">Control.Immortal</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Aeson.Extended.html"><span class="hs-identifier">Data.Aeson.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src/Data.Aeson.Ordered.html"><span class="hs-identifier">Data.Aeson.Ordered</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">JO</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Endo</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/uuid-1.3.15-27c4aaffbeaba346bef13811d3f6d406e6ac2b25d893ea4219c2fe8f7abc24ba/share/doc/html/src/Data.UUID.V4.html"><span class="hs-identifier">Data.UUID.V4</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Options</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Plan</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.Poll.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerResponseState"><span class="hs-identifier">PollerResponseState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSError"><span class="hs-identifier">PRSError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSSuccess"><span class="hs-identifier">PRSSuccess</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Subscription.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier">OperationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier">OperationId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-prelude-0.1.0.0/opt/doc/html/hasura-prelude/src/Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.IR.ModelInformation.html"><span class="hs-identifier">Hasura.RQL.IR.ModelInformation</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html"><span class="hs-identifier">Hasura.RQL.Types.Action</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html"><span class="hs-identifier">Hasura.Server.Prometheus</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Server.Prometheus.html#DynamicGraphqlOperationLabel"><span class="hs-identifier">DynamicGraphqlOperationLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier">PrometheusMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier">SubscriptionLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#SubscriptionMetrics"><span class="hs-identifier">SubscriptionMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier">liveQuerySubscriptionLabel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier">recordMetricWithLabel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Hasura.Server.Prometheus.html#streamingSubscriptionLabel"><span class="hs-identifier">streamingSubscriptionLabel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#ModelInfoLogState"><span class="hs-identifier">ModelInfoLogState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier">RequestId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/graphql-parser-0.2.0.0/opt/doc/html/graphql-parser/src/Language.GraphQL.Draft.Syntax.html"><span class="hs-identifier">Language.GraphQL.Draft.Syntax</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html"><span class="hs-identifier">Refined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier">unrefine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html"><span class="hs-identifier">StmContainers.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STMMap</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html"><span class="hs-identifier">System.Metrics.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html"><span class="hs-identifier">System.Metrics.Prometheus.Gauge</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Prometheus.Gauge</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html"><span class="hs-identifier">System.Metrics.Prometheus.GaugeVector</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GaugeVector</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | The top-level datatype that holds the state for all active subscriptions.</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- NOTE!: This must be kept consistent with a websocket connection's</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- 'OperationMap', in 'onClose' and 'onStart'.</span><span>
</span><span id="line-79"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriptionsState"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-var">SubscriptionsState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriptionsState"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-var">SubscriptionsState</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_ssLiveQueryMap"><span class="annot"><span class="annottext">SubscriptionsState -&gt; PollerMap ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssLiveQueryMap"><span class="hs-identifier hs-var hs-var">_ssLiveQueryMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span id="_ssStreamQueryMap"><span class="annot"><span class="annottext">SubscriptionsState -&gt; PollerMap (TVar CursorVariableValues)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssStreamQueryMap"><span class="hs-identifier hs-var hs-var">_ssStreamQueryMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-comment">-- | A hook function which is run after each fetch cycle</span></span><span>
</span><span id="line-83"></span><span>    </span><span id="_ssPostPollHook"><span class="annot"><span class="annottext">SubscriptionsState -&gt; SubscriptionPostPollHook
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssPostPollHook"><span class="hs-identifier hs-var hs-var">_ssPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span id="_ssAsyncActions"><span class="annot"><span class="annottext">SubscriptionsState -&gt; AsyncActionSubscriptionState
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssAsyncActions"><span class="hs-identifier hs-var hs-var">_ssAsyncActions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#initSubscriptionsState"><span class="hs-identifier hs-type">initSubscriptionsState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriptionPostPollHook"><span class="hs-identifier hs-type">SubscriptionPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span>
</span><span id="line-88"></span><span id="initSubscriptionsState"><span class="annot"><span class="annottext">initSubscriptionsState :: SubscriptionPostPollHook -&gt; IO SubscriptionsState
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#initSubscriptionsState"><span class="hs-identifier hs-var hs-var">initSubscriptionsState</span></a></span></span><span> </span><span id="local-6989586621688003917"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688003917"><span class="hs-identifier hs-var">pollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><span class="annottext">STM SubscriptionsState -&gt; IO SubscriptionsState
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">(STM SubscriptionsState -&gt; IO SubscriptionsState)
-&gt; STM SubscriptionsState -&gt; IO SubscriptionsState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
-&gt; PollerMap (TVar CursorVariableValues)
-&gt; SubscriptionPostPollHook
-&gt; AsyncActionSubscriptionState
-&gt; SubscriptionsState
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-var">SubscriptionsState</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="annottext">(PollerMap ()
 -&gt; PollerMap (TVar CursorVariableValues)
 -&gt; SubscriptionPostPollHook
 -&gt; AsyncActionSubscriptionState
 -&gt; SubscriptionsState)
-&gt; STM (PollerMap ())
-&gt; STM
     (PollerMap (TVar CursorVariableValues)
      -&gt; SubscriptionPostPollHook
      -&gt; AsyncActionSubscriptionState
      -&gt; SubscriptionsState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (PollerMap ())
forall key value. STM (Map key value)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#new"><span class="hs-identifier hs-var">STMMap.new</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">STM
  (PollerMap (TVar CursorVariableValues)
   -&gt; SubscriptionPostPollHook
   -&gt; AsyncActionSubscriptionState
   -&gt; SubscriptionsState)
-&gt; STM (PollerMap (TVar CursorVariableValues))
-&gt; STM
     (SubscriptionPostPollHook
      -&gt; AsyncActionSubscriptionState -&gt; SubscriptionsState)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (PollerMap (TVar CursorVariableValues))
forall key value. STM (Map key value)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#new"><span class="hs-identifier hs-var">STMMap.new</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="annottext">STM
  (SubscriptionPostPollHook
   -&gt; AsyncActionSubscriptionState -&gt; SubscriptionsState)
-&gt; STM SubscriptionPostPollHook
-&gt; STM (AsyncActionSubscriptionState -&gt; SubscriptionsState)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook -&gt; STM SubscriptionPostPollHook
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688003917"><span class="hs-identifier hs-var">pollHook</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">STM (AsyncActionSubscriptionState -&gt; SubscriptionsState)
-&gt; STM AsyncActionSubscriptionState -&gt; STM SubscriptionsState
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM AsyncActionSubscriptionState
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="annot"><span class="hs-comment">-- | For dev debugging, output subject to change.</span></span><span>
</span><span id="line-97"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#dumpSubscriptionsState"><span class="hs-identifier hs-type">dumpSubscriptionsState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#StreamQueriesOptions"><span class="hs-identifier hs-type">StreamQueriesOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#Value"><span class="hs-identifier hs-type">J.Value</span></a></span><span>
</span><span id="line-98"></span><span id="dumpSubscriptionsState"><span class="annot"><span class="annottext">dumpSubscriptionsState :: Bool
-&gt; LiveQueriesOptions
-&gt; LiveQueriesOptions
-&gt; SubscriptionsState
-&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#dumpSubscriptionsState"><span class="hs-identifier hs-var hs-var">dumpSubscriptionsState</span></a></span></span><span> </span><span id="local-6989586621688003923"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688003923"><span class="hs-identifier hs-var">extended</span></a></span></span><span> </span><span id="local-6989586621688003924"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688003924"><span class="hs-identifier hs-var">liveQOpts</span></a></span></span><span> </span><span id="local-6989586621688003925"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688003925"><span class="hs-identifier hs-var">streamQOpts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span id="local-6989586621688003926"><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688003926"><span class="hs-identifier hs-var">lqMap</span></a></span></span><span> </span><span id="local-6989586621688003927"><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688003927"><span class="hs-identifier hs-var">streamMap</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621688003928"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688003928"><span class="hs-identifier hs-var">lqMapJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; PollerMap () -&gt; IO Value
forall streamCursor. Bool -&gt; PollerMap streamCursor -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpPollerMap"><span class="hs-identifier hs-var">dumpPollerMap</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688003923"><span class="hs-identifier hs-var">extended</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688003926"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621688003930"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688003930"><span class="hs-identifier hs-var">streamMapJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; PollerMap (TVar CursorVariableValues) -&gt; IO Value
forall streamCursor. Bool -&gt; PollerMap streamCursor -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#dumpPollerMap"><span class="hs-identifier hs-var">dumpPollerMap</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688003923"><span class="hs-identifier hs-var">extended</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688003927"><span class="hs-identifier hs-var">streamMap</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.Internal.html#object"><span class="hs-identifier hs-var">J.object</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;options&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; LiveQueriesOptions -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688003924"><span class="hs-identifier hs-var">liveQOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;live_queries_map&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688003928"><span class="hs-identifier hs-var">lqMapJ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;stream_queries_map&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688003930"><span class="hs-identifier hs-var">streamMapJ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;stream_queries_options&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; LiveQueriesOptions -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
forall v. ToJSON v =&gt; Key -&gt; v -&gt; Pair
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/aeson-2.1.2.1-e70cfd91223b3d0131c9afbae5e81df0c65350557c5511cf0c25a451c1483207/share/doc/html/src/Data.Aeson.Types.ToJSON.html#.%3D"><span class="hs-operator hs-var">J..=</span></a></span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688003925"><span class="hs-identifier hs-var">streamQOpts</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- | SubscriberDetails contains the data required to locate a subscriber</span><span>
</span><span id="line-110"></span><span class="hs-comment">--   in the correct cohort within the correct poller in the operation map.</span><span>
</span><span id="line-111"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriberDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-var">SubscriberDetails</span></a></span></span><span> </span><span id="local-6989586621688003525"><span class="annot"><a href="#local-6989586621688003525"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-var">SubscriberDetails</span></a></span></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sdPoller"><span class="annot"><span class="annottext">forall a. SubscriberDetails a -&gt; BackendPollerKey
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_sdPoller"><span class="hs-identifier hs-var hs-var">_sdPoller</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BackendPollerKey"><span class="hs-identifier hs-type">BackendPollerKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>    </span><span id="_sdCohort"><span class="annot"><span class="annottext">forall a. SubscriberDetails a -&gt; a
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_sdCohort"><span class="hs-identifier hs-var hs-var">_sdCohort</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621688003525"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>    </span><span id="_sdSubscriber"><span class="annot"><span class="annottext">forall a. SubscriberDetails a -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_sdSubscriber"><span class="hs-identifier hs-var hs-var">_sdSubscriber</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688003939"><span id="local-6989586621688003946"><span id="local-6989586621688003949"><span class="annot"><span class="annottext">Int -&gt; SubscriberDetails a -&gt; ShowS
[SubscriberDetails a] -&gt; ShowS
SubscriberDetails a -&gt; String
(Int -&gt; SubscriberDetails a -&gt; ShowS)
-&gt; (SubscriberDetails a -&gt; String)
-&gt; ([SubscriberDetails a] -&gt; ShowS)
-&gt; Show (SubscriberDetails a)
forall a. Show a =&gt; Int -&gt; SubscriberDetails a -&gt; ShowS
forall a. Show a =&gt; [SubscriberDetails a] -&gt; ShowS
forall a. Show a =&gt; SubscriberDetails a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; SubscriberDetails a -&gt; ShowS
showsPrec :: Int -&gt; SubscriberDetails a -&gt; ShowS
$cshow :: forall a. Show a =&gt; SubscriberDetails a -&gt; String
show :: SubscriberDetails a -&gt; String
$cshowList :: forall a. Show a =&gt; [SubscriberDetails a] -&gt; ShowS
showList :: [SubscriberDetails a] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-keyword">type</span><span> </span><span id="LiveQuerySubscriberDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-var">LiveQuerySubscriberDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-type">SubscriberDetails</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | The `CohortKey` contains the variables with which the subscription was started</span><span>
</span><span id="line-121"></span><span class="hs-comment">--   and which will remain unchanged. The second type contains the mutable reference</span><span>
</span><span id="line-122"></span><span class="hs-comment">--   through which we can get the latest value of the cursor and using both the `CohortKey`</span><span>
</span><span id="line-123"></span><span class="hs-comment">--   and the latest cursor value, we locate the subscriber in the operation map to find its</span><span>
</span><span id="line-124"></span><span class="hs-comment">--   details and then stop it.</span><span>
</span><span id="line-125"></span><span class="hs-keyword">type</span><span> </span><span id="StreamingSubscriberDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#StreamingSubscriberDetails"><span class="hs-identifier hs-var">StreamingSubscriberDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-type">SubscriberDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | `findPollerForSubscriber` places a subscriber in the correct poller.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--   If the poller doesn't exist then we create one otherwise we return the</span><span>
</span><span id="line-129"></span><span class="hs-comment">--   existing one.</span><span>
</span><span id="line-130"></span><span id="local-6989586621688003533"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#findPollerForSubscriber"><span class="hs-identifier hs-type">findPollerForSubscriber</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BackendPollerKey"><span class="hs-identifier hs-type">BackendPollerKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.STM</span></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM.STM</span></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM.STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621688003533"><span class="hs-identifier hs-type">streamCursorVars</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-140"></span><span id="findPollerForSubscriber"><span class="annot"><span class="annottext">findPollerForSubscriber :: forall streamCursorVars.
Subscriber
-&gt; PollerMap streamCursorVars
-&gt; BackendPollerKey
-&gt; CohortVariables
-&gt; (Subscriber -&gt; Cohort streamCursorVars -&gt; STM streamCursorVars)
-&gt; (Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars)
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#findPollerForSubscriber"><span class="hs-identifier hs-var hs-var">findPollerForSubscriber</span></a></span></span><span> </span><span id="local-6989586621688003986"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688003986"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688003987"><span class="annot"><span class="annottext">PollerMap streamCursorVars
</span><a href="#local-6989586621688003987"><span class="hs-identifier hs-var">pollerMap</span></a></span></span><span> </span><span id="local-6989586621688003988"><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688003988"><span class="hs-identifier hs-var">pollerKey</span></a></span></span><span> </span><span id="local-6989586621688003989"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688003989"><span class="hs-identifier hs-var">cohortKey</span></a></span></span><span> </span><span id="local-6989586621688003990"><span class="annot"><span class="annottext">Subscriber -&gt; Cohort streamCursorVars -&gt; STM streamCursorVars
</span><a href="#local-6989586621688003990"><span class="hs-identifier hs-var">addToCohort</span></a></span></span><span> </span><span id="local-6989586621688003991"><span class="annot"><span class="annottext">Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars
</span><a href="#local-6989586621688003991"><span class="hs-identifier hs-var">addToPoller</span></a></span></span><span> </span><span id="local-6989586621688003992"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688003992"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621688003993"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688003993"><span class="hs-identifier hs-var">maybeOperationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">-- a handler is returned only when it is newly created</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><span class="annottext">BackendPollerKey
-&gt; PollerMap streamCursorVars
-&gt; STM (Maybe (Poller streamCursorVars))
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM (Maybe value)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#lookup"><span class="hs-identifier hs-var">STMMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688003988"><span class="hs-identifier hs-var">pollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap streamCursorVars
</span><a href="#local-6989586621688003987"><span class="hs-identifier hs-var">pollerMap</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe (Poller streamCursorVars))
-&gt; (Maybe (Poller streamCursorVars)
    -&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars))
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688003995"><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-comment">-- Found a poller, now check if a cohort also exists</span><span>
</span><span id="line-145"></span><span>      </span><span id="local-6989586621688003996"><span class="annot"><span class="annottext">streamCursorVars
</span><a href="#local-6989586621688003996"><span class="hs-identifier hs-var">cursorVars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">CohortVariables
-&gt; TMap CohortVariables (Cohort streamCursorVars)
-&gt; STM (Maybe (Cohort streamCursorVars))
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688003989"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller streamCursorVars
-&gt; TMap CohortVariables (Cohort streamCursorVars)
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (Cohort streamCursorVars))
-&gt; (Maybe (Cohort streamCursorVars) -&gt; STM streamCursorVars)
-&gt; STM streamCursorVars
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-147"></span><span>          </span><span class="hs-comment">-- cohort found too! Simply add the subscriber to the cohort</span><span>
</span><span id="line-148"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688003999"><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621688003999"><span class="hs-identifier hs-var">cohort</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; Cohort streamCursorVars -&gt; STM streamCursorVars
</span><a href="#local-6989586621688003990"><span class="hs-identifier hs-var">addToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688003986"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621688003999"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-comment">-- cohort not found. Create a cohort with the subscriber and add</span><span>
</span><span id="line-150"></span><span>          </span><span class="hs-comment">-- the cohort to the poller</span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Cohort streamCursorVars)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars
</span><a href="#local-6989586621688003991"><span class="hs-identifier hs-var">addToPoller</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688003986"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-comment">-- Add the operation name of the subcription to the poller, if it doesn't exist</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-comment">-- else increment the count for the operation name</span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><span class="annottext">Maybe OperationName
-&gt; TMap (Maybe OperationName) Int -&gt; STM (Maybe Int)
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688003993"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller streamCursorVars -&gt; TMap (Maybe OperationName) Int
forall streamCursor.
Poller streamCursor -&gt; TMap (Maybe OperationName) Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pOperationNamesMap"><span class="hs-identifier hs-var">_pOperationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM (Maybe Int) -&gt; (Maybe Int -&gt; STM ()) -&gt; STM ()
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688003993"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller streamCursorVars -&gt; TMap (Maybe OperationName) Int
forall streamCursor.
Poller streamCursor -&gt; TMap (Maybe OperationName) Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pOperationNamesMap"><span class="hs-identifier hs-var">_pOperationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int)
-&gt; Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; (v -&gt; v) -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#adjust"><span class="hs-identifier hs-var">TMap.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688003993"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller streamCursorVars -&gt; TMap (Maybe OperationName) Int
forall streamCursor.
Poller streamCursor -&gt; TMap (Maybe OperationName) Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pOperationNamesMap"><span class="hs-identifier hs-var">_pOperationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688003995"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Poller streamCursorVars), streamCursorVars)
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Poller streamCursorVars)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">streamCursorVars
</span><a href="#local-6989586621688003996"><span class="hs-identifier hs-var">cursorVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Poller streamCursorVars)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-comment">-- no poller found, so create one with the cohort</span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-comment">-- and the subscriber within it.</span><span>
</span><span id="line-161"></span><span>      </span><span id="local-6989586621688004004"><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004004"><span class="hs-identifier hs-var">operationNamesMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMap (Maybe OperationName) Int)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><span class="annottext">Int
-&gt; Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688003993"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004004"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621688004005"><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688004005"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap CohortVariables (Cohort streamCursorVars)
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; ParameterizedQueryHash
-&gt; TMap (Maybe OperationName) Int
-&gt; Poller streamCursorVars
forall streamCursor.
CohortMap streamCursor
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; ParameterizedQueryHash
-&gt; TMap (Maybe OperationName) Int
-&gt; Poller streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span><span> </span><span class="annot"><span class="annottext">(TMap CohortVariables (Cohort streamCursorVars)
 -&gt; TVar PollerResponseState
 -&gt; TMVar PollerIOState
 -&gt; ParameterizedQueryHash
 -&gt; TMap (Maybe OperationName) Int
 -&gt; Poller streamCursorVars)
-&gt; STM (TMap CohortVariables (Cohort streamCursorVars))
-&gt; STM
     (TVar PollerResponseState
      -&gt; TMVar PollerIOState
      -&gt; ParameterizedQueryHash
      -&gt; TMap (Maybe OperationName) Int
      -&gt; Poller streamCursorVars)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap CohortVariables (Cohort streamCursorVars))
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  (TVar PollerResponseState
   -&gt; TMVar PollerIOState
   -&gt; ParameterizedQueryHash
   -&gt; TMap (Maybe OperationName) Int
   -&gt; Poller streamCursorVars)
-&gt; STM (TVar PollerResponseState)
-&gt; STM
     (TMVar PollerIOState
      -&gt; ParameterizedQueryHash
      -&gt; TMap (Maybe OperationName) Int
      -&gt; Poller streamCursorVars)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState -&gt; STM (TVar PollerResponseState)
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVar</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSSuccess"><span class="hs-identifier hs-var">PRSSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  (TMVar PollerIOState
   -&gt; ParameterizedQueryHash
   -&gt; TMap (Maybe OperationName) Int
   -&gt; Poller streamCursorVars)
-&gt; STM (TMVar PollerIOState)
-&gt; STM
     (ParameterizedQueryHash
      -&gt; TMap (Maybe OperationName) Int -&gt; Poller streamCursorVars)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMVar PollerIOState)
forall a. STM (TMVar a)
</span><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></span><span> </span><span class="annot"><span class="annottext">STM
  (ParameterizedQueryHash
   -&gt; TMap (Maybe OperationName) Int -&gt; Poller streamCursorVars)
-&gt; STM ParameterizedQueryHash
-&gt; STM (TMap (Maybe OperationName) Int -&gt; Poller streamCursorVars)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash -&gt; STM ParameterizedQueryHash
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688003992"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMap (Maybe OperationName) Int -&gt; Poller streamCursorVars)
-&gt; STM (TMap (Maybe OperationName) Int)
-&gt; STM (Poller streamCursorVars)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
-&gt; STM (TMap (Maybe OperationName) Int)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004004"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-164"></span><span>      </span><span id="local-6989586621688004009"><span class="annot"><span class="annottext">streamCursorVars
</span><a href="#local-6989586621688004009"><span class="hs-identifier hs-var">cursorVars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars
</span><a href="#local-6989586621688003991"><span class="hs-identifier hs-var">addToPoller</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688003986"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688004005"><span class="hs-identifier hs-var">poller</span></a></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">Poller streamCursorVars
-&gt; BackendPollerKey -&gt; PollerMap streamCursorVars -&gt; STM ()
forall key value.
(Eq key, Hashable key) =&gt;
value -&gt; key -&gt; Map key value -&gt; STM ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#insert"><span class="hs-identifier hs-var">STMMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688004005"><span class="hs-identifier hs-var">poller</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688003988"><span class="hs-identifier hs-var">pollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap streamCursorVars
</span><a href="#local-6989586621688003987"><span class="hs-identifier hs-var">pollerMap</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Poller streamCursorVars), streamCursorVars)
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (Poller streamCursorVars), streamCursorVars)
 -&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars))
-&gt; (Maybe (Poller streamCursorVars), streamCursorVars)
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller streamCursorVars -&gt; Maybe (Poller streamCursorVars)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Poller streamCursorVars
</span><a href="#local-6989586621688004005"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">streamCursorVars
</span><a href="#local-6989586621688004009"><span class="hs-identifier hs-var">cursorVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><span class="hs-comment">-- | Fork a thread handling a regular (live query) subscription</span></span><span>
</span><span id="line-169"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addLiveQuery"><span class="hs-identifier hs-type">addLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688003561"><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#StreamQueriesOptions"><span class="hs-identifier hs-type">StreamQueriesOptions</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="hs-comment">-- | operation name of the query</span></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#SubscriptionQueryPlan"><span class="hs-identifier hs-type">SubscriptionQueryPlan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><span class="hs-comment">-- | the action to be executed when result changes</span></span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#OnChange"><span class="hs-identifier hs-type">OnChange</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src/Data.Aeson.Ordered.html#Value"><span class="hs-identifier hs-type">JO.Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.IR.ModelInformation.Types.html#ModelInfoPart"><span class="hs-identifier hs-type">ModelInfoPart</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#ModelInfoLogState"><span class="hs-identifier hs-type">ModelInfoLogState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-type">LiveQuerySubscriberDetails</span></a></span><span>
</span><span id="line-191"></span><span id="addLiveQuery"><span class="annot"><span class="annottext">addLiveQuery :: forall (b :: BackendType).
BackendTransport b =&gt;
Logger Hasura
-&gt; ServerMetrics
-&gt; PrometheusMetrics
-&gt; SubscriberMetadata
-&gt; SubscriptionsState
-&gt; IO (LiveQueriesOptions, LiveQueriesOptions)
-&gt; SourceName
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; RequestId
-&gt; SubscriptionQueryPlan b (MultiplexedQuery b)
-&gt; IO GranularPrometheusMetricsState
-&gt; OnChange
-&gt; Maybe (Endo Value)
-&gt; [ModelInfoPart]
-&gt; IO ModelInfoLogState
-&gt; IO LiveQuerySubscriberDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#addLiveQuery"><span class="hs-identifier hs-var hs-var">addLiveQuery</span></a></span></span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621688004071"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004071"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621688004072"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004072"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621688004073"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004073"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span>
</span><span id="line-195"></span><span>  </span><span id="local-6989586621688004074"><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688004074"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span></span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621688004075"><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004075"><span class="hs-identifier hs-var">subscriptionState</span></a></span></span><span>
</span><span id="line-197"></span><span>  </span><span id="local-6989586621688004076"><span class="annot"><span class="annottext">IO (LiveQueriesOptions, LiveQueriesOptions)
</span><a href="#local-6989586621688004076"><span class="hs-identifier hs-var">getSubscriptionOptions</span></a></span></span><span>
</span><span id="line-198"></span><span>  </span><span id="local-6989586621688004077"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004077"><span class="hs-identifier hs-var">source</span></a></span></span><span>
</span><span id="line-199"></span><span>  </span><span id="local-6989586621688004078"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004078"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621688004079"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004079"><span class="hs-identifier hs-var">operationName</span></a></span></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621688004080"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688004080"><span class="hs-identifier hs-var">requestId</span></a></span></span><span>
</span><span id="line-202"></span><span>  </span><span id="local-6989586621688004081"><span class="annot"><span class="annottext">SubscriptionQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688004081"><span class="hs-identifier hs-var">plan</span></a></span></span><span>
</span><span id="line-203"></span><span>  </span><span id="local-6989586621688004082"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004082"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span>
</span><span id="line-204"></span><span>  </span><span id="local-6989586621688004083"><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688004083"><span class="hs-identifier hs-var">onResultAction</span></a></span></span><span>
</span><span id="line-205"></span><span>  </span><span id="local-6989586621688004084"><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621688004084"><span class="hs-identifier hs-var">modifier</span></a></span></span><span>
</span><span id="line-206"></span><span>  </span><span id="local-6989586621688004085"><span class="annot"><span class="annottext">[ModelInfoPart]
</span><a href="#local-6989586621688004085"><span class="hs-identifier hs-var">modelInfo</span></a></span></span><span>
</span><span id="line-207"></span><span>  </span><span id="local-6989586621688004086"><span class="annot"><span class="annottext">IO ModelInfoLogState
</span><a href="#local-6989586621688004086"><span class="hs-identifier hs-var">modelInfoLogStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- CAREFUL!: It's absolutely crucial that we can't throw any exceptions here!</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-comment">-- disposable subscriber UUID:</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621688004087"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004087"><span class="hs-identifier hs-var">subscriberId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#newSubscriberId"><span class="hs-identifier hs-var">newSubscriberId</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688004089"><span class="annot"><span class="annottext">subscriber :: Subscriber
</span><a href="#local-6989586621688004089"><span class="hs-identifier hs-var hs-var">subscriber</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriberId
-&gt; SubscriberMetadata
-&gt; RequestId
-&gt; Maybe OperationName
-&gt; OnChange
-&gt; Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004087"><span class="hs-identifier hs-var">subscriberId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688004074"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688004080"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004079"><span class="hs-identifier hs-var">operationName</span></a></span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688004083"><span class="hs-identifier hs-var">onResultAction</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">$</span><span class="annot"><span class="annottext">String
String -&gt; Subscriber -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ghc-heap-view-0.6.4-f3db7814b25c86ce10e8e9996b01c55915a4624099b8464adbe1f6a62fc2a06b/share/doc/html/src/GHC.AssertNF.html#assertNFNamed"><span class="hs-identifier hs-var">assertNFHere</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004089"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621688004092"><span class="annot"><span class="annottext">Maybe (Poller ())
</span><a href="#local-6989586621688004092"><span class="hs-identifier hs-var">pollerMaybe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">STM (Maybe (Poller ()), ()) -&gt; IO (Maybe (Poller ()), ())
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><span class="annottext">(STM (Maybe (Poller ()), ()) -&gt; IO (Maybe (Poller ()), ()))
-&gt; STM (Maybe (Poller ()), ()) -&gt; IO (Maybe (Poller ()), ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subscriber
-&gt; PollerMap ()
-&gt; BackendPollerKey
-&gt; CohortVariables
-&gt; (Subscriber -&gt; Cohort () -&gt; STM ())
-&gt; (Subscriber -&gt; Poller () -&gt; STM ())
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; STM (Maybe (Poller ()), ())
forall streamCursorVars.
Subscriber
-&gt; PollerMap streamCursorVars
-&gt; BackendPollerKey
-&gt; CohortVariables
-&gt; (Subscriber -&gt; Cohort streamCursorVars -&gt; STM streamCursorVars)
-&gt; (Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars)
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#findPollerForSubscriber"><span class="hs-identifier hs-var">findPollerForSubscriber</span></a></span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004089"><span class="hs-identifier hs-var">subscriber</span></a></span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004093"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-220"></span><span>          </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004094"><span class="hs-identifier hs-var">handlerId</span></a></span><span>
</span><span id="line-221"></span><span>          </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004095"><span class="hs-identifier hs-var">cohortKey</span></a></span><span>
</span><span id="line-222"></span><span>          </span><span class="annot"><span class="annottext">Subscriber -&gt; Cohort () -&gt; STM ()
forall {streamCursorVars}.
Subscriber -&gt; Cohort streamCursorVars -&gt; STM ()
</span><a href="#local-6989586621688004096"><span class="hs-identifier hs-var">addToCohort</span></a></span><span>
</span><span id="line-223"></span><span>          </span><span class="annot"><span class="annottext">Subscriber -&gt; Poller () -&gt; STM ()
</span><a href="#local-6989586621688004097"><span class="hs-identifier hs-var">addToPoller</span></a></span><span>
</span><span id="line-224"></span><span>          </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004078"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-225"></span><span>          </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004079"><span class="hs-identifier hs-var">operationName</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- we can then attach a polling thread if it is new the livequery can only be</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- cancelled after putTMVar</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Poller ()) -&gt; (Poller () -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller ())
</span><a href="#local-6989586621688004092"><span class="hs-identifier hs-var">pollerMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">((Poller () -&gt; IO ()) -&gt; IO ()) -&gt; (Poller () -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688004099"><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004099"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>      </span><span id="local-6989586621688004100"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004100"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UUID -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; PollerId) -&gt; IO UUID -&gt; IO PollerId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/uuid-1.3.15-27c4aaffbeaba346bef13811d3f6d406e6ac2b25d893ea4219c2fe8f7abc24ba/share/doc/html/src/Data.UUID.V4.html#nextRandom"><span class="hs-identifier hs-var">UUID.nextRandom</span></a></span><span>
</span><span id="line-231"></span><span>      </span><span id="local-6989586621688004103"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004103"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; IO Void -&gt; IO Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
</span><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-var">forkImmortal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pollLiveQuery.&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PollerId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004100"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004071"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">(IO Void -&gt; IO Thread) -&gt; IO Void -&gt; IO Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; IO Void) -&gt; IO () -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621688004106"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004106"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (LiveQueriesOptions, LiveQueriesOptions)
</span><a href="#local-6989586621688004076"><span class="hs-identifier hs-var">getSubscriptionOptions</span></a></span><span>
</span><span id="line-235"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688004108"><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688004108"><span class="hs-identifier hs-var">refetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004106"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-236"></span><span>          </span><span class="annot"><span class="annottext">forall (b :: BackendType).
BackendTransport b =&gt;
PollerId
-&gt; TVar PollerResponseState
-&gt; LiveQueriesOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap 'LiveQuery
-&gt; SubscriptionPostPollHook
-&gt; PrometheusMetrics
-&gt; IO GranularPrometheusMetricsState
-&gt; TMap (Maybe OperationName) Int
-&gt; ResolvedConnectionTemplate b
-&gt; Maybe (Endo Value)
-&gt; Logger Hasura
-&gt; [ModelInfoPart]
-&gt; IO ModelInfoLogState
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.LiveQuery.html#pollLiveQuery"><span class="hs-identifier hs-var">pollLiveQuery</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004100"><span class="hs-identifier hs-var">pollerId</span></a></span><span>
</span><span id="line-238"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller () -&gt; TVar PollerResponseState
forall streamCursor.
Poller streamCursor -&gt; TVar PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pPollerState"><span class="hs-identifier hs-var">_pPollerState</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004099"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>            </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004106"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-240"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004077"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688004111"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>            </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004112"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004078"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-243"></span><span>            </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004113"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller () -&gt; CohortMap ()
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004099"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>            </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688004114"><span class="hs-identifier hs-var">postPollHook</span></a></span><span>
</span><span id="line-246"></span><span>            </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004073"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004082"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-248"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller () -&gt; TMap (Maybe OperationName) Int
forall streamCursor.
Poller streamCursor -&gt; TMap (Maybe OperationName) Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pOperationNamesMap"><span class="hs-identifier hs-var">_pOperationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004099"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004115"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span><span>
</span><span id="line-250"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621688004084"><span class="hs-identifier hs-var">modifier</span></a></span><span>
</span><span id="line-251"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004071"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-252"></span><span>            </span><span class="annot"><span class="annottext">[ModelInfoPart]
</span><a href="#local-6989586621688004085"><span class="hs-identifier hs-var">modelInfo</span></a></span><span>
</span><span id="line-253"></span><span>            </span><span class="annot"><span class="annottext">IO ModelInfoLogState
</span><a href="#local-6989586621688004086"><span class="hs-identifier hs-var">modelInfoLogStatus</span></a></span><span>
</span><span id="line-254"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; IO ()) -&gt; DiffTime -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative DiffTime -&gt; DiffTime
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">(Refined NonNegative DiffTime -&gt; DiffTime)
-&gt; Refined NonNegative DiffTime -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval -&gt; Refined NonNegative DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Options.html#unRefetchInterval"><span class="hs-identifier hs-var">unRefetchInterval</span></a></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688004108"><span class="hs-identifier hs-var">refetchInterval</span></a></span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688004117"><span class="annot"><span class="annottext">pState :: PollerIOState
</span><a href="#local-6989586621688004117"><span class="hs-identifier hs-var hs-var">pState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Thread -&gt; PollerId -&gt; PollerIOState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004103"><span class="hs-identifier hs-var">threadRef</span></a></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004100"><span class="hs-identifier hs-var">pollerId</span></a></span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-special">$</span><span class="annot"><span class="annottext">String
String -&gt; PollerIOState -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ghc-heap-view-0.6.4-f3db7814b25c86ce10e8e9996b01c55915a4624099b8464adbe1f6a62fc2a06b/share/doc/html/src/GHC.AssertNF.html#assertNFNamed"><span class="hs-identifier hs-var">assertNFHere</span></a></span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688004117"><span class="hs-identifier hs-var">pState</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; PollerIOState -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.putTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller () -&gt; TMVar PollerIOState
forall streamCursor. Poller streamCursor -&gt; TMVar PollerIOState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pIOState"><span class="hs-identifier hs-var">_pIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004099"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688004117"><span class="hs-identifier hs-var">pState</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#inc"><span class="hs-identifier hs-var">Prometheus.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveLiveQueryPollers"><span class="hs-identifier hs-var">submActiveLiveQueryPollers</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004073"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004072"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004127"><span class="annot"><span class="annottext">promMetricGranularLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004127"><span class="hs-identifier hs-var hs-var">promMetricGranularLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicGraphqlOperationLabel -&gt; Maybe DynamicGraphqlOperationLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DynamicGraphqlOperationLabel
 -&gt; Maybe DynamicGraphqlOperationLabel)
-&gt; DynamicGraphqlOperationLabel
-&gt; Maybe DynamicGraphqlOperationLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ParameterizedQueryHash
-&gt; Maybe OperationName -&gt; DynamicGraphqlOperationLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicGraphqlOperationLabel"><span class="hs-identifier hs-var">DynamicGraphqlOperationLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParameterizedQueryHash -&gt; Maybe ParameterizedQueryHash
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004078"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004079"><span class="hs-identifier hs-var">operationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>        </span><span id="local-6989586621688004130"><span class="annot"><span class="annottext">promMetricLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004130"><span class="hs-identifier hs-var hs-var">promMetricLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicGraphqlOperationLabel
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004131"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004131"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004073"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004082"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-267"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#inc"><span class="hs-identifier hs-var">GaugeVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004131"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004127"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#inc"><span class="hs-identifier hs-var">GaugeVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004131"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004130"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveLiveQueries"><span class="hs-identifier hs-var">smActiveLiveQueries</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004072"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><span class="annottext">LiveQuerySubscriberDetails -&gt; IO LiveQuerySubscriberDetails
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(LiveQuerySubscriberDetails -&gt; IO LiveQuerySubscriberDetails)
-&gt; LiveQuerySubscriberDetails -&gt; IO LiveQuerySubscriberDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
-&gt; CohortVariables -&gt; SubscriberId -&gt; LiveQuerySubscriberDetails
forall a.
BackendPollerKey -&gt; a -&gt; SubscriberId -&gt; SubscriberDetails a
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-var">SubscriberDetails</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004094"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004095"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004087"><span class="hs-identifier hs-var">subscriberId</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span id="local-6989586621688004093"><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004093"><span class="hs-identifier hs-var">lqMap</span></a></span></span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688004114"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688004114"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004075"><span class="hs-identifier hs-var">subscriptionState</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#SubscriptionQueryPlan"><span class="hs-identifier hs-type">SubscriptionQueryPlan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#ParameterizedSubscriptionQueryPlan"><span class="hs-identifier hs-type">ParameterizedSubscriptionQueryPlan</span></a></span><span> </span><span id="local-6989586621688004112"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004112"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688004113"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004113"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004111"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688004111"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688004137"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688004137"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span id="local-6989586621688004115"><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004115"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span></span><span> </span><span id="local-6989586621688004095"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004095"><span class="hs-identifier hs-var">cohortKey</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688004081"><span class="hs-identifier hs-var">plan</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>      </span><span id="local-6989586621688004094"><span class="annot"><span class="annottext">handlerId :: BackendPollerKey
</span><a href="#local-6989586621688004094"><span class="hs-identifier hs-var hs-var">handlerId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnyBackend PollerKey -&gt; BackendPollerKey
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BackendPollerKey"><span class="hs-identifier hs-var">BackendPollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend PollerKey -&gt; BackendPollerKey)
-&gt; AnyBackend PollerKey -&gt; BackendPollerKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688003561"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(PollerKey b -&gt; AnyBackend PollerKey)
-&gt; PollerKey b -&gt; AnyBackend PollerKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; RoleName
-&gt; Text
-&gt; ResolvedConnectionTemplate b
-&gt; ParameterizedQueryHash
-&gt; PollerKey b
forall (b :: BackendType).
SourceName
-&gt; RoleName
-&gt; Text
-&gt; ResolvedConnectionTemplate b
-&gt; ParameterizedQueryHash
-&gt; PollerKey b
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004077"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004112"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004113"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004115"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004078"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621688004096"><span class="annot"><span class="annottext">addToCohort :: Subscriber -&gt; Cohort streamCursorVars -&gt; STM ()
</span><a href="#local-6989586621688004096"><span class="hs-identifier hs-var hs-var">addToCohort</span></a></span></span><span> </span><span id="local-6989586621688004143"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004143"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688004144"><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621688004144"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">Subscriber
-&gt; SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004143"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sId"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004143"><span class="hs-identifier hs-var">subscriber</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM ())
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort streamCursorVars
</span><a href="#local-6989586621688004144"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>      </span><span id="local-6989586621688004097"><span class="annot"><span class="annottext">addToPoller :: Subscriber -&gt; Poller () -&gt; STM ()
</span><a href="#local-6989586621688004097"><span class="hs-identifier hs-var hs-var">addToPoller</span></a></span></span><span> </span><span id="local-6989586621688004147"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004147"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688004148"><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004148"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621688004149"><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004149"><span class="hs-identifier hs-var">newCohort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-283"></span><span>          </span><span class="annot"><span class="annottext">CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; ()
-&gt; Cohort ()
forall streamCursorVars.
CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; streamCursorVars
-&gt; Cohort streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688004137"><span class="hs-identifier hs-var">cohortId</span></a></span><span>
</span><span id="line-284"></span><span>            </span><span class="annot"><span class="annottext">(TVar (Maybe ResponseHash)
 -&gt; TMap SubscriberId Subscriber
 -&gt; TMap SubscriberId Subscriber
 -&gt; ()
 -&gt; Cohort ())
-&gt; STM (TVar (Maybe ResponseHash))
-&gt; STM
     (TMap SubscriberId Subscriber
      -&gt; TMap SubscriberId Subscriber -&gt; () -&gt; Cohort ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; STM (TVar (Maybe ResponseHash))
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVar</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-285"></span><span>            </span><span class="annot"><span class="annottext">STM
  (TMap SubscriberId Subscriber
   -&gt; TMap SubscriberId Subscriber -&gt; () -&gt; Cohort ())
-&gt; STM (TMap SubscriberId Subscriber)
-&gt; STM (TMap SubscriberId Subscriber -&gt; () -&gt; Cohort ())
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber -&gt; () -&gt; Cohort ())
-&gt; STM (TMap SubscriberId Subscriber) -&gt; STM (() -&gt; Cohort ())
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">STM (() -&gt; Cohort ()) -&gt; STM () -&gt; STM (Cohort ())
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><span class="annottext">Subscriber -&gt; Cohort () -&gt; STM ()
forall {streamCursorVars}.
Subscriber -&gt; Cohort streamCursorVars -&gt; STM ()
</span><a href="#local-6989586621688004096"><span class="hs-identifier hs-var">addToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004147"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004149"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">Cohort () -&gt; CohortVariables -&gt; CohortMap () -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004149"><span class="hs-identifier hs-var">newCohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004095"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">(CohortMap () -&gt; STM ()) -&gt; CohortMap () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Poller () -&gt; CohortMap ()
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004148"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="annot"><span class="hs-comment">-- | Fork a thread handling a streaming subscription</span></span><span>
</span><span id="line-292"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addStreamSubscriptionQuery"><span class="hs-identifier hs-type">addStreamSubscriptionQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688003649"><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#StreamQueriesOptions"><span class="hs-identifier hs-type">StreamQueriesOptions</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="hs-comment">-- | operation name of the query</span></span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><span class="hs-comment">-- | root field name</span></span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/graphql-parser-0.2.0.0/opt/doc/html/graphql-parser/src/Language.GraphQL.Draft.Syntax.Name.html#Name"><span class="hs-identifier hs-type">G.Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#SubscriptionQueryPlan"><span class="hs-identifier hs-type">SubscriptionQueryPlan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="hs-comment">-- | the action to be executed when result changes</span></span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#OnChange"><span class="hs-identifier hs-type">OnChange</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="hs-comment">-- | the modifier for adding typename for namespaced queries</span></span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/aeson-ordered-0.1.0.0/opt/doc/html/aeson-ordered/src/Data.Aeson.Ordered.html#Value"><span class="hs-identifier hs-type">JO.Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.IR.ModelInformation.Types.html#ModelInfoPart"><span class="hs-identifier hs-type">ModelInfoPart</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#ModelInfoLogState"><span class="hs-identifier hs-type">ModelInfoLogState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#StreamingSubscriberDetails"><span class="hs-identifier hs-type">StreamingSubscriberDetails</span></a></span><span>
</span><span id="line-317"></span><span id="addStreamSubscriptionQuery"><span class="annot"><span class="annottext">addStreamSubscriptionQuery :: forall (b :: BackendType).
BackendTransport b =&gt;
Logger Hasura
-&gt; ServerMetrics
-&gt; PrometheusMetrics
-&gt; SubscriberMetadata
-&gt; SubscriptionsState
-&gt; IO (LiveQueriesOptions, LiveQueriesOptions)
-&gt; SourceName
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; RequestId
-&gt; Name
-&gt; SubscriptionQueryPlan b (MultiplexedQuery b)
-&gt; IO GranularPrometheusMetricsState
-&gt; OnChange
-&gt; Maybe (Endo Value)
-&gt; [ModelInfoPart]
-&gt; IO ModelInfoLogState
-&gt; IO StreamingSubscriberDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#addStreamSubscriptionQuery"><span class="hs-identifier hs-var hs-var">addStreamSubscriptionQuery</span></a></span></span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621688004204"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004204"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621688004205"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004205"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621688004206"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004206"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span>
</span><span id="line-321"></span><span>  </span><span id="local-6989586621688004207"><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688004207"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span></span><span>
</span><span id="line-322"></span><span>  </span><span id="local-6989586621688004208"><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004208"><span class="hs-identifier hs-var">subscriptionState</span></a></span></span><span>
</span><span id="line-323"></span><span>  </span><span id="local-6989586621688004209"><span class="annot"><span class="annottext">IO (LiveQueriesOptions, LiveQueriesOptions)
</span><a href="#local-6989586621688004209"><span class="hs-identifier hs-var">getSubscriptionOptions</span></a></span></span><span>
</span><span id="line-324"></span><span>  </span><span id="local-6989586621688004210"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004210"><span class="hs-identifier hs-var">source</span></a></span></span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621688004211"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004211"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span>
</span><span id="line-326"></span><span>  </span><span id="local-6989586621688004212"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004212"><span class="hs-identifier hs-var">operationName</span></a></span></span><span>
</span><span id="line-327"></span><span>  </span><span id="local-6989586621688004213"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688004213"><span class="hs-identifier hs-var">requestId</span></a></span></span><span>
</span><span id="line-328"></span><span>  </span><span id="local-6989586621688004214"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688004214"><span class="hs-identifier hs-var">rootFieldName</span></a></span></span><span>
</span><span id="line-329"></span><span>  </span><span id="local-6989586621688004215"><span class="annot"><span class="annottext">SubscriptionQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688004215"><span class="hs-identifier hs-var">plan</span></a></span></span><span>
</span><span id="line-330"></span><span>  </span><span id="local-6989586621688004216"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004216"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span>
</span><span id="line-331"></span><span>  </span><span id="local-6989586621688004217"><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688004217"><span class="hs-identifier hs-var">onResultAction</span></a></span></span><span>
</span><span id="line-332"></span><span>  </span><span id="local-6989586621688004218"><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621688004218"><span class="hs-identifier hs-var">modifier</span></a></span></span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621688004219"><span class="annot"><span class="annottext">[ModelInfoPart]
</span><a href="#local-6989586621688004219"><span class="hs-identifier hs-var">modelInfo</span></a></span></span><span>
</span><span id="line-334"></span><span>  </span><span id="local-6989586621688004220"><span class="annot"><span class="annottext">IO ModelInfoLogState
</span><a href="#local-6989586621688004220"><span class="hs-identifier hs-var">modelInfoLogStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-comment">-- CAREFUL!: It's absolutely crucial that we can't throw any exceptions here!</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-comment">-- disposable subscriber UUID:</span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621688004221"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004221"><span class="hs-identifier hs-var">subscriberId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#newSubscriberId"><span class="hs-identifier hs-var">newSubscriberId</span></a></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688004222"><span class="annot"><span class="annottext">subscriber :: Subscriber
</span><a href="#local-6989586621688004222"><span class="hs-identifier hs-var hs-var">subscriber</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriberId
-&gt; SubscriberMetadata
-&gt; RequestId
-&gt; Maybe OperationName
-&gt; OnChange
-&gt; Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004221"><span class="hs-identifier hs-var">subscriberId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688004207"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688004213"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004212"><span class="hs-identifier hs-var">operationName</span></a></span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688004217"><span class="hs-identifier hs-var">onResultAction</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-special">$</span><span class="annot"><span class="annottext">String
String -&gt; Subscriber -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ghc-heap-view-0.6.4-f3db7814b25c86ce10e8e9996b01c55915a4624099b8464adbe1f6a62fc2a06b/share/doc/html/src/GHC.AssertNF.html#assertNFNamed"><span class="hs-identifier hs-var">assertNFHere</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004222"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621688004223"><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
</span><a href="#local-6989586621688004223"><span class="hs-identifier hs-var">handlerM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004224"><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004224"><span class="hs-identifier hs-var">cohortCursorTVar</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">STM
  (Maybe (Poller (TVar CursorVariableValues)),
   TVar CursorVariableValues)
-&gt; IO
     (Maybe (Poller (TVar CursorVariableValues)),
      TVar CursorVariableValues)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">(STM
   (Maybe (Poller (TVar CursorVariableValues)),
    TVar CursorVariableValues)
 -&gt; IO
      (Maybe (Poller (TVar CursorVariableValues)),
       TVar CursorVariableValues))
-&gt; STM
     (Maybe (Poller (TVar CursorVariableValues)),
      TVar CursorVariableValues)
-&gt; IO
     (Maybe (Poller (TVar CursorVariableValues)),
      TVar CursorVariableValues)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subscriber
-&gt; PollerMap (TVar CursorVariableValues)
-&gt; BackendPollerKey
-&gt; CohortVariables
-&gt; (Subscriber
    -&gt; Cohort (TVar CursorVariableValues)
    -&gt; STM (TVar CursorVariableValues))
-&gt; (Subscriber
    -&gt; Poller (TVar CursorVariableValues)
    -&gt; STM (TVar CursorVariableValues))
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; STM
     (Maybe (Poller (TVar CursorVariableValues)),
      TVar CursorVariableValues)
forall streamCursorVars.
Subscriber
-&gt; PollerMap streamCursorVars
-&gt; BackendPollerKey
-&gt; CohortVariables
-&gt; (Subscriber -&gt; Cohort streamCursorVars -&gt; STM streamCursorVars)
-&gt; (Subscriber -&gt; Poller streamCursorVars -&gt; STM streamCursorVars)
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; STM (Maybe (Poller streamCursorVars), streamCursorVars)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#findPollerForSubscriber"><span class="hs-identifier hs-var">findPollerForSubscriber</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004222"><span class="hs-identifier hs-var">subscriber</span></a></span><span>
</span><span id="line-346"></span><span>          </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004225"><span class="hs-identifier hs-var">streamQueryMap</span></a></span><span>
</span><span id="line-347"></span><span>          </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004226"><span class="hs-identifier hs-var">handlerId</span></a></span><span>
</span><span id="line-348"></span><span>          </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004227"><span class="hs-identifier hs-var">cohortKey</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span class="annot"><span class="annottext">Subscriber
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (TVar CursorVariableValues)
forall {b}. Subscriber -&gt; Cohort b -&gt; STM b
</span><a href="#local-6989586621688004228"><span class="hs-identifier hs-var">addToCohort</span></a></span><span>
</span><span id="line-350"></span><span>          </span><span class="annot"><span class="annottext">Subscriber
-&gt; Poller (TVar CursorVariableValues)
-&gt; STM (TVar CursorVariableValues)
</span><a href="#local-6989586621688004229"><span class="hs-identifier hs-var">addToPoller</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004211"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004212"><span class="hs-identifier hs-var">operationName</span></a></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-comment">-- we can then attach a polling thread if it is new the subscription can only be</span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-comment">-- cancelled after putTMVar</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
-&gt; (Poller (TVar CursorVariableValues) -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
</span><a href="#local-6989586621688004223"><span class="hs-identifier hs-var">handlerM</span></a></span><span> </span><span class="annot"><span class="annottext">((Poller (TVar CursorVariableValues) -&gt; IO ()) -&gt; IO ())
-&gt; (Poller (TVar CursorVariableValues) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688004230"><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004230"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>      </span><span id="local-6989586621688004231"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004231"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UUID -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; PollerId) -&gt; IO UUID -&gt; IO PollerId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/uuid-1.3.15-27c4aaffbeaba346bef13811d3f6d406e6ac2b25d893ea4219c2fe8f7abc24ba/share/doc/html/src/Data.UUID.V4.html#nextRandom"><span class="hs-identifier hs-var">UUID.nextRandom</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span id="local-6989586621688004232"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004232"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; IO Void -&gt; IO Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
</span><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-var">forkImmortal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pollStreamingQuery.&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">UUID -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PollerId -&gt; UUID
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#unPollerId"><span class="hs-identifier hs-var">unPollerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004231"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004204"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">(IO Void -&gt; IO Thread) -&gt; IO Void -&gt; IO Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; IO Void) -&gt; IO () -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-361"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004234"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004234"><span class="hs-identifier hs-var">streamQOpts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (LiveQueriesOptions, LiveQueriesOptions)
</span><a href="#local-6989586621688004209"><span class="hs-identifier hs-var">getSubscriptionOptions</span></a></span><span>
</span><span id="line-362"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Options.html#SubscriptionsOptions"><span class="hs-identifier hs-type">SubscriptionsOptions</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688004235"><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688004235"><span class="hs-identifier hs-var">refetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004234"><span class="hs-identifier hs-var">streamQOpts</span></a></span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">forall (b :: BackendType).
BackendTransport b =&gt;
PollerId
-&gt; TVar PollerResponseState
-&gt; LiveQueriesOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap 'Streaming
-&gt; Name
-&gt; SubscriptionPostPollHook
-&gt; Maybe (IO ())
-&gt; PrometheusMetrics
-&gt; IO GranularPrometheusMetricsState
-&gt; TMap (Maybe OperationName) Int
-&gt; ResolvedConnectionTemplate b
-&gt; Maybe (Endo Value)
-&gt; Logger Hasura
-&gt; [ModelInfoPart]
-&gt; IO ModelInfoLogState
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.StreamingQuery.html#pollStreamingQuery"><span class="hs-identifier hs-var">pollStreamingQuery</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004231"><span class="hs-identifier hs-var">pollerId</span></a></span><span>
</span><span id="line-365"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues) -&gt; TVar PollerResponseState
forall streamCursor.
Poller streamCursor -&gt; TVar PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pPollerState"><span class="hs-identifier hs-var">_pPollerState</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004230"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688004234"><span class="hs-identifier hs-var">streamQOpts</span></a></span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004210"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688004237"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004238"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004211"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004239"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
-&gt; CohortMap (TVar CursorVariableValues)
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004230"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621688004214"><span class="hs-identifier hs-var">rootFieldName</span></a></span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688004240"><span class="hs-identifier hs-var">postPollHook</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004206"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004216"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
-&gt; TMap (Maybe OperationName) Int
forall streamCursor.
Poller streamCursor -&gt; TMap (Maybe OperationName) Int
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pOperationNamesMap"><span class="hs-identifier hs-var">_pOperationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004230"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>            </span><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004241"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Endo Value)
</span><a href="#local-6989586621688004218"><span class="hs-identifier hs-var">modifier</span></a></span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004204"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-381"></span><span>            </span><span class="annot"><span class="annottext">[ModelInfoPart]
</span><a href="#local-6989586621688004219"><span class="hs-identifier hs-var">modelInfo</span></a></span><span>
</span><span id="line-382"></span><span>            </span><span class="annot"><span class="annottext">IO ModelInfoLogState
</span><a href="#local-6989586621688004220"><span class="hs-identifier hs-var">modelInfoLogStatus</span></a></span><span>
</span><span id="line-383"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; IO ()) -&gt; DiffTime -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Refined NonNegative DiffTime -&gt; DiffTime
forall {k} (p :: k) x. Refined p x -&gt; x
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/refined-0.8-b40efcc9b0260e802a32460f94ca38ced336d3f5163ccc01fe8e32d7f56bcb6d/share/doc/html/src/Refined.html#unrefine"><span class="hs-identifier hs-var">unrefine</span></a></span><span> </span><span class="annot"><span class="annottext">(Refined NonNegative DiffTime -&gt; DiffTime)
-&gt; Refined NonNegative DiffTime -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval -&gt; Refined NonNegative DiffTime
</span><a href="Hasura.GraphQL.Execute.Subscription.Options.html#unRefetchInterval"><span class="hs-identifier hs-var">unRefetchInterval</span></a></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688004235"><span class="hs-identifier hs-var">refetchInterval</span></a></span><span>
</span><span id="line-384"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688004242"><span class="annot"><span class="annottext">pState :: PollerIOState
</span><a href="#local-6989586621688004242"><span class="hs-identifier hs-var hs-var">pState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Thread -&gt; PollerId -&gt; PollerIOState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004232"><span class="hs-identifier hs-var">threadRef</span></a></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688004231"><span class="hs-identifier hs-var">pollerId</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-special">$</span><span class="annot"><span class="annottext">String
String -&gt; PollerIOState -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ghc-heap-view-0.6.4-f3db7814b25c86ce10e8e9996b01c55915a4624099b8464adbe1f6a62fc2a06b/share/doc/html/src/GHC.AssertNF.html#assertNFNamed"><span class="hs-identifier hs-var">assertNFHere</span></a></span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688004242"><span class="hs-identifier hs-var">pState</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-386"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; PollerIOState -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.putTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues) -&gt; TMVar PollerIOState
forall streamCursor. Poller streamCursor -&gt; TMVar PollerIOState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pIOState"><span class="hs-identifier hs-var">_pIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004230"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688004242"><span class="hs-identifier hs-var">pState</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#inc"><span class="hs-identifier hs-var">Prometheus.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveStreamingPollers"><span class="hs-identifier hs-var">submActiveStreamingPollers</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004206"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004205"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-391"></span><span>      </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#inc"><span class="hs-identifier hs-var">EKG.Gauge.inc</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveStreamingSubscriptions"><span class="hs-identifier hs-var">smActiveStreamingSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004205"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004245"><span class="annot"><span class="annottext">promMetricGranularLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004245"><span class="hs-identifier hs-var hs-var">promMetricGranularLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#streamingSubscriptionLabel"><span class="hs-identifier hs-var">streamingSubscriptionLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicGraphqlOperationLabel -&gt; Maybe DynamicGraphqlOperationLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DynamicGraphqlOperationLabel
 -&gt; Maybe DynamicGraphqlOperationLabel)
-&gt; DynamicGraphqlOperationLabel
-&gt; Maybe DynamicGraphqlOperationLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ParameterizedQueryHash
-&gt; Maybe OperationName -&gt; DynamicGraphqlOperationLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicGraphqlOperationLabel"><span class="hs-identifier hs-var">DynamicGraphqlOperationLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParameterizedQueryHash -&gt; Maybe ParameterizedQueryHash
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004211"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004212"><span class="hs-identifier hs-var">operationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>        </span><span id="local-6989586621688004246"><span class="annot"><span class="annottext">promMetricLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004246"><span class="hs-identifier hs-var hs-var">promMetricLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#streamingSubscriptionLabel"><span class="hs-identifier hs-var">streamingSubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicGraphqlOperationLabel
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-395"></span><span>        </span><span id="local-6989586621688004247"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004247"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004206"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004216"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#inc"><span class="hs-identifier hs-var">GaugeVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004247"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004245"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#inc"><span class="hs-identifier hs-var">GaugeVector.inc</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004247"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004246"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span>    </span><span class="annot"><span class="annottext">StreamingSubscriberDetails -&gt; IO StreamingSubscriberDetails
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StreamingSubscriberDetails -&gt; IO StreamingSubscriberDetails)
-&gt; StreamingSubscriberDetails -&gt; IO StreamingSubscriberDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
-&gt; (CohortVariables, TVar CursorVariableValues)
-&gt; SubscriberId
-&gt; StreamingSubscriberDetails
forall a.
BackendPollerKey -&gt; a -&gt; SubscriberId -&gt; SubscriberDetails a
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-var">SubscriberDetails</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004226"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004227"><span class="hs-identifier hs-var">cohortKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004224"><span class="hs-identifier hs-var">cohortCursorTVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004221"><span class="hs-identifier hs-var">subscriberId</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688004225"><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004225"><span class="hs-identifier hs-var">streamQueryMap</span></a></span></span><span> </span><span id="local-6989586621688004240"><span class="annot"><span class="annottext">SubscriptionPostPollHook
</span><a href="#local-6989586621688004240"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004208"><span class="hs-identifier hs-var">subscriptionState</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#SubscriptionQueryPlan"><span class="hs-identifier hs-type">SubscriptionQueryPlan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#ParameterizedSubscriptionQueryPlan"><span class="hs-identifier hs-type">ParameterizedSubscriptionQueryPlan</span></a></span><span> </span><span id="local-6989586621688004238"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004238"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688004239"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004239"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004237"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688004237"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688004248"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688004248"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span id="local-6989586621688004241"><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004241"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span></span><span> </span><span id="local-6989586621688004227"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004227"><span class="hs-identifier hs-var">cohortKey</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688004215"><span class="hs-identifier hs-var">plan</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>      </span><span id="local-6989586621688004226"><span class="annot"><span class="annottext">handlerId :: BackendPollerKey
</span><a href="#local-6989586621688004226"><span class="hs-identifier hs-var hs-var">handlerId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnyBackend PollerKey -&gt; BackendPollerKey
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#BackendPollerKey"><span class="hs-identifier hs-var">BackendPollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">(AnyBackend PollerKey -&gt; BackendPollerKey)
-&gt; AnyBackend PollerKey -&gt; BackendPollerKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
i b -&gt; AnyBackend i
</span><a href="Hasura.SQL.AnyBackend.html#mkAnyBackend"><span class="hs-identifier hs-var">AB.mkAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688003649"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">(PollerKey b -&gt; AnyBackend PollerKey)
-&gt; PollerKey b -&gt; AnyBackend PollerKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; RoleName
-&gt; Text
-&gt; ResolvedConnectionTemplate b
-&gt; ParameterizedQueryHash
-&gt; PollerKey b
forall (b :: BackendType).
SourceName
-&gt; RoleName
-&gt; Text
-&gt; ResolvedConnectionTemplate b
-&gt; ParameterizedQueryHash
-&gt; PollerKey b
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688004210"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688004238"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-extras-1.0.0/opt/doc/html/hasura-extras/src/Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688004239"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ResolvedConnectionTemplate b
</span><a href="#local-6989586621688004241"><span class="hs-identifier hs-var">resolvedConnectionTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004211"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>      </span><span id="local-6989586621688004228"><span class="annot"><span class="annottext">addToCohort :: Subscriber -&gt; Cohort b -&gt; STM b
</span><a href="#local-6989586621688004228"><span class="hs-identifier hs-var hs-var">addToCohort</span></a></span></span><span> </span><span id="local-6989586621688004252"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004252"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688004253"><span class="annot"><span class="annottext">Cohort b
</span><a href="#local-6989586621688004253"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">Subscriber
-&gt; SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004252"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_sId"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004252"><span class="hs-identifier hs-var">subscriber</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM ())
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort b -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort b
</span><a href="#local-6989586621688004253"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="annottext">b -&gt; STM b
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; STM b) -&gt; b -&gt; STM b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort b -&gt; b
forall streamCursorVars.
Cohort streamCursorVars -&gt; streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cStreamCursorVariables"><span class="hs-identifier hs-var">_cStreamCursorVariables</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort b
</span><a href="#local-6989586621688004253"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>      </span><span id="local-6989586621688004229"><span class="annot"><span class="annottext">addToPoller :: Subscriber
-&gt; Poller (TVar CursorVariableValues)
-&gt; STM (TVar CursorVariableValues)
</span><a href="#local-6989586621688004229"><span class="hs-identifier hs-var hs-var">addToPoller</span></a></span></span><span> </span><span id="local-6989586621688004255"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004255"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688004256"><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004256"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>        </span><span id="local-6989586621688004257"><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004257"><span class="hs-identifier hs-var">latestCursorValues</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-415"></span><span>          </span><span class="annot"><span class="annottext">CursorVariableValues -&gt; STM (TVar CursorVariableValues)
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal -&gt; CursorVariableValues
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-var">CursorVariableValues</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidatedVariables (HashMap Name) -&gt; HashMap Name TxtEncodedVal
forall (f :: * -&gt; *). ValidatedVariables f -&gt; f TxtEncodedVal
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#_unValidatedVariables"><span class="hs-identifier hs-var">_unValidatedVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortVariables -&gt; ValidatedVariables (HashMap Name)
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#_cvCursorVariables"><span class="hs-identifier hs-var">_cvCursorVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004227"><span class="hs-identifier hs-var">cohortKey</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621688004261"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004261"><span class="hs-identifier hs-var">newCohort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; TVar CursorVariableValues
-&gt; Cohort (TVar CursorVariableValues)
forall streamCursorVars.
CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; streamCursorVars
-&gt; Cohort streamCursorVars
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688004248"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar (Maybe ResponseHash)
 -&gt; TMap SubscriberId Subscriber
 -&gt; TMap SubscriberId Subscriber
 -&gt; TVar CursorVariableValues
 -&gt; Cohort (TVar CursorVariableValues))
-&gt; STM (TVar (Maybe ResponseHash))
-&gt; STM
     (TMap SubscriberId Subscriber
      -&gt; TMap SubscriberId Subscriber
      -&gt; TVar CursorVariableValues
      -&gt; Cohort (TVar CursorVariableValues))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; STM (TVar (Maybe ResponseHash))
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVar</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">STM
  (TMap SubscriberId Subscriber
   -&gt; TMap SubscriberId Subscriber
   -&gt; TVar CursorVariableValues
   -&gt; Cohort (TVar CursorVariableValues))
-&gt; STM (TMap SubscriberId Subscriber)
-&gt; STM
     (TMap SubscriberId Subscriber
      -&gt; TVar CursorVariableValues -&gt; Cohort (TVar CursorVariableValues))
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  (TMap SubscriberId Subscriber
   -&gt; TVar CursorVariableValues -&gt; Cohort (TVar CursorVariableValues))
-&gt; STM (TMap SubscriberId Subscriber)
-&gt; STM
     (TVar CursorVariableValues -&gt; Cohort (TVar CursorVariableValues))
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  (TVar CursorVariableValues -&gt; Cohort (TVar CursorVariableValues))
-&gt; STM (TVar CursorVariableValues)
-&gt; STM (Cohort (TVar CursorVariableValues))
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues -&gt; STM (TVar CursorVariableValues)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004257"><span class="hs-identifier hs-var">latestCursorValues</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span id="local-6989586621688004262"><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004262"><span class="hs-identifier hs-var">cohortCursorVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subscriber
-&gt; Cohort (TVar CursorVariableValues)
-&gt; STM (TVar CursorVariableValues)
forall {b}. Subscriber -&gt; Cohort b -&gt; STM b
</span><a href="#local-6989586621688004228"><span class="hs-identifier hs-var">addToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688004255"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004261"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
-&gt; CohortVariables
-&gt; CohortMap (TVar CursorVariableValues)
-&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004261"><span class="hs-identifier hs-var">newCohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004227"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">(CohortMap (TVar CursorVariableValues) -&gt; STM ())
-&gt; CohortMap (TVar CursorVariableValues) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
-&gt; CohortMap (TVar CursorVariableValues)
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004256"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">TVar CursorVariableValues -&gt; STM (TVar CursorVariableValues)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004262"><span class="hs-identifier hs-var">cohortCursorVals</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeLiveQuery"><span class="hs-identifier hs-type">removeLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-comment">-- the query and the associated operation</span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-type">LiveQuerySubscriberDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-428"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span id="removeLiveQuery"><span class="annot"><span class="annottext">removeLiveQuery :: Logger Hasura
-&gt; ServerMetrics
-&gt; PrometheusMetrics
-&gt; SubscriptionsState
-&gt; LiveQuerySubscriberDetails
-&gt; IO GranularPrometheusMetricsState
-&gt; Maybe OperationName
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeLiveQuery"><span class="hs-identifier hs-var hs-var">removeLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688004263"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004263"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688004264"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004264"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688004265"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004265"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span> </span><span id="local-6989586621688004266"><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004266"><span class="hs-identifier hs-var">lqState</span></a></span></span><span> </span><span id="local-6989586621688004267"><span class="annot"><span class="annottext">lqId :: LiveQuerySubscriberDetails
</span><a href="#local-6989586621688004267"><span class="hs-identifier hs-var">lqId</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-type">SubscriberDetails</span></a></span><span> </span><span id="local-6989586621688004268"><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004268"><span class="hs-identifier hs-var">handlerId</span></a></span></span><span> </span><span id="local-6989586621688004269"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004269"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span id="local-6989586621688004270"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004270"><span class="hs-identifier hs-var">sinkId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004271"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004271"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span> </span><span id="local-6989586621688004272"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004272"><span class="hs-identifier hs-var">maybeOperationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>  </span><span class="annot"><span class="annottext">IO (IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><span class="annottext">(IO (IO ()) -&gt; IO ()) -&gt; IO (IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM (IO ()) -&gt; IO (IO ())
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><span class="annottext">(STM (IO ()) -&gt; IO (IO ())) -&gt; STM (IO ()) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>      </span><span id="local-6989586621688004273"><span class="annot"><span class="annottext">Maybe (Poller (), Cohort ())
</span><a href="#local-6989586621688004273"><span class="hs-identifier hs-var">detM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PollerMap () -&gt; STM (Maybe (Poller (), Cohort ()))
</span><a href="#local-6989586621688004274"><span class="hs-identifier hs-var">getQueryDet</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004275"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Poller (), Cohort ())
</span><a href="#local-6989586621688004273"><span class="hs-identifier hs-var">detM</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-437"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Poller (), Cohort ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span id="local-6989586621688004276"><span class="annot"><span class="annottext">CohortMap ()
</span><a href="#local-6989586621688004276"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span id="local-6989586621688004277"><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004277"><span class="hs-identifier hs-var">pollerState</span></a></span></span><span> </span><span id="local-6989586621688004278"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004278"><span class="hs-identifier hs-var">ioState</span></a></span></span><span> </span><span id="local-6989586621688004279"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004279"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621688004280"><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004280"><span class="hs-identifier hs-var">operationNamesMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004281"><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004281"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>          </span><span class="annot"><span class="annottext">Maybe OperationName
-&gt; TMap (Maybe OperationName) Int -&gt; STM (Maybe Int)
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004272"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004280"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe Int) -&gt; (Maybe Int -&gt; STM ()) -&gt; STM ()
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-440"></span><span>            </span><span class="hs-comment">-- If only one operation name is present in the map, delete it</span><span>
</span><span id="line-441"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004272"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004280"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-442"></span><span>            </span><span class="hs-comment">-- If the count of a operation name is more than 1, then it means there</span><span>
</span><span id="line-443"></span><span>            </span><span class="hs-comment">-- are more subscriptions with the same name and we should keep emitting</span><span>
</span><span id="line-444"></span><span>            </span><span class="hs-comment">-- the metrics until the all the subscription with that operaion name are</span><span>
</span><span id="line-445"></span><span>            </span><span class="hs-comment">-- removed</span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int)
-&gt; Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; (v -&gt; v) -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#adjust"><span class="hs-identifier hs-var">TMap.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688004283"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688004283"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688004283"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004272"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004280"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>          </span><span class="annot"><span class="annottext">CohortMap ()
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; Cohort ()
-&gt; ParameterizedQueryHash
-&gt; STM (IO ())
</span><a href="#local-6989586621688004284"><span class="hs-identifier hs-var">cleanHandlerC</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap ()
</span><a href="#local-6989586621688004276"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004277"><span class="hs-identifier hs-var">pollerState</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004278"><span class="hs-identifier hs-var">ioState</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004281"><span class="hs-identifier hs-var">cohort</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004279"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004264"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveLiveQueries"><span class="hs-identifier hs-var">smActiveLiveQueries</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004264"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-452"></span><span>    </span><span id="local-6989586621688004275"><span class="annot"><span class="annottext">lqMap :: PollerMap ()
</span><a href="#local-6989586621688004275"><span class="hs-identifier hs-var hs-var">lqMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsState -&gt; PollerMap ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssLiveQueryMap"><span class="hs-identifier hs-var">_ssLiveQueryMap</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004266"><span class="hs-identifier hs-var">lqState</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621688004274"><span class="annot"><span class="annottext">getQueryDet :: PollerMap () -&gt; STM (Maybe (Poller (), Cohort ()))
</span><a href="#local-6989586621688004274"><span class="hs-identifier hs-var hs-var">getQueryDet</span></a></span></span><span> </span><span id="local-6989586621688004286"><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004286"><span class="hs-identifier hs-var">subMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>      </span><span id="local-6989586621688004287"><span class="annot"><span class="annottext">Maybe (Poller ())
</span><a href="#local-6989586621688004287"><span class="hs-identifier hs-var">pollerM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BackendPollerKey -&gt; PollerMap () -&gt; STM (Maybe (Poller ()))
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM (Maybe value)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#lookup"><span class="hs-identifier hs-var">STMMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004268"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004286"><span class="hs-identifier hs-var">subMap</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Maybe (Poller (), Cohort ()))
 -&gt; Maybe (Poller (), Cohort ()))
-&gt; STM (Maybe (Maybe (Poller (), Cohort ())))
-&gt; STM (Maybe (Poller (), Cohort ()))
forall a b. (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (Poller (), Cohort ()))
-&gt; Maybe (Poller (), Cohort ())
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">(STM (Maybe (Maybe (Poller (), Cohort ())))
 -&gt; STM (Maybe (Poller (), Cohort ())))
-&gt; STM (Maybe (Maybe (Poller (), Cohort ())))
-&gt; STM (Maybe (Poller (), Cohort ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller ())
-&gt; (Poller () -&gt; STM (Maybe (Poller (), Cohort ())))
-&gt; STM (Maybe (Maybe (Poller (), Cohort ())))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller ())
</span><a href="#local-6989586621688004287"><span class="hs-identifier hs-var">pollerM</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">((Poller () -&gt; STM (Maybe (Poller (), Cohort ())))
 -&gt; STM (Maybe (Maybe (Poller (), Cohort ()))))
-&gt; (Poller () -&gt; STM (Maybe (Poller (), Cohort ())))
-&gt; STM (Maybe (Maybe (Poller (), Cohort ())))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688004289"><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004289"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>          </span><span id="local-6989586621688004290"><span class="annot"><span class="annottext">Maybe (Cohort ())
</span><a href="#local-6989586621688004290"><span class="hs-identifier hs-var">cohortM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortVariables -&gt; CohortMap () -&gt; STM (Maybe (Cohort ()))
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004269"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller () -&gt; CohortMap ()
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004289"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Poller (), Cohort ()) -&gt; STM (Maybe (Poller (), Cohort ()))
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Poller (), Cohort ())
 -&gt; STM (Maybe (Poller (), Cohort ())))
-&gt; Maybe (Poller (), Cohort ())
-&gt; STM (Maybe (Poller (), Cohort ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller ()
</span><a href="#local-6989586621688004289"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Cohort () -&gt; (Poller (), Cohort ()))
-&gt; Maybe (Cohort ()) -&gt; Maybe (Poller (), Cohort ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Cohort ())
</span><a href="#local-6989586621688004290"><span class="hs-identifier hs-var">cohortM</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>    </span><span id="local-6989586621688004284"><span class="annot"><span class="annottext">cleanHandlerC :: CohortMap ()
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; Cohort ()
-&gt; ParameterizedQueryHash
-&gt; STM (IO ())
</span><a href="#local-6989586621688004284"><span class="hs-identifier hs-var hs-var">cleanHandlerC</span></a></span></span><span> </span><span id="local-6989586621688004291"><span class="annot"><span class="annottext">CohortMap ()
</span><a href="#local-6989586621688004291"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621688004292"><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004292"><span class="hs-identifier hs-var">pollerState</span></a></span></span><span> </span><span id="local-6989586621688004293"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004293"><span class="hs-identifier hs-var">ioState</span></a></span></span><span> </span><span id="local-6989586621688004294"><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004294"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span> </span><span id="local-6989586621688004295"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004295"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004296"><span class="annot"><span class="annottext">curOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004296"><span class="hs-identifier hs-var hs-var">curOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort () -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var">_cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004294"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-464"></span><span>          </span><span id="local-6989586621688004298"><span class="annot"><span class="annottext">newOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004298"><span class="hs-identifier hs-var hs-var">newOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort () -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort ()
</span><a href="#local-6989586621688004294"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004270"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004296"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-466"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004270"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004298"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-467"></span><span>      </span><span id="local-6989586621688004299"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004299"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-468"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">(&amp;&amp;)</span></span><span>
</span><span id="line-469"></span><span>          </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool) -&gt; STM Bool -&gt; STM (Bool -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004296"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-470"></span><span>          </span><span class="annot"><span class="annottext">STM (Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004298"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-471"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004299"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables -&gt; CohortMap () -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004269"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap ()
</span><a href="#local-6989586621688004291"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-472"></span><span>      </span><span id="local-6989586621688004303"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004303"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortMap () -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap ()
</span><a href="#local-6989586621688004291"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004304"><span class="annot"><span class="annottext">promMetricGranularLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004304"><span class="hs-identifier hs-var hs-var">promMetricGranularLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicGraphqlOperationLabel -&gt; Maybe DynamicGraphqlOperationLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DynamicGraphqlOperationLabel
 -&gt; Maybe DynamicGraphqlOperationLabel)
-&gt; DynamicGraphqlOperationLabel
-&gt; Maybe DynamicGraphqlOperationLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ParameterizedQueryHash
-&gt; Maybe OperationName -&gt; DynamicGraphqlOperationLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicGraphqlOperationLabel"><span class="hs-identifier hs-var">DynamicGraphqlOperationLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParameterizedQueryHash -&gt; Maybe ParameterizedQueryHash
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004295"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004272"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>          </span><span id="local-6989586621688004305"><span class="annot"><span class="annottext">promMetricLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004305"><span class="hs-identifier hs-var hs-var">promMetricLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#liveQuerySubscriptionLabel"><span class="hs-identifier hs-var">liveQuerySubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicGraphqlOperationLabel
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-comment">-- when there is no need for handler i.e, this happens to be the last</span><span>
</span><span id="line-476"></span><span>      </span><span class="hs-comment">-- operation, take the ref for the polling thread to cancel it</span><span>
</span><span id="line-477"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004303"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>          </span><span class="annot"><span class="annottext">BackendPollerKey -&gt; PollerMap () -&gt; STM ()
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#delete"><span class="hs-identifier hs-var">STMMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004268"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap ()
</span><a href="#local-6989586621688004275"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-480"></span><span>          </span><span id="local-6989586621688004307"><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688004307"><span class="hs-identifier hs-var">threadRefM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PollerIOState -&gt; Thread) -&gt; Maybe PollerIOState -&gt; Maybe Thread
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PollerIOState -&gt; Thread
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pThread"><span class="hs-identifier hs-var">_pThread</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PollerIOState -&gt; Maybe Thread)
-&gt; STM (Maybe PollerIOState) -&gt; STM (Maybe Thread)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; STM (Maybe PollerIOState)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">STM.tryReadTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004293"><span class="hs-identifier hs-var">ioState</span></a></span><span>
</span><span id="line-481"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-482"></span><span>            </span><span class="annot"><span class="annottext">(IO () -&gt; STM (IO ())) -&gt; IO () -&gt; STM (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-comment">-- deferred IO:</span><span>
</span><span id="line-484"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688004307"><span class="hs-identifier hs-var">threadRefM</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688004310"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004310"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>                </span><span class="annot"><span class="annottext">Thread -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/immortal-0.2.2.1-e3bd4e0e64dc114baa3abc247b1e60df834aa7935cf82aff7a3976b9f7bb0e91/share/doc/html/src/Control.Immortal.html#stop"><span class="hs-identifier hs-var">Immortal.stop</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004310"><span class="hs-identifier hs-var">threadRef</span></a></span><span>
</span><span id="line-487"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>                  </span><span id="local-6989586621688004312"><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621688004312"><span class="hs-identifier hs-var">pollerLastState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState -&gt; IO PollerResponseState
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004292"><span class="hs-identifier hs-var">pollerState</span></a></span><span>
</span><span id="line-489"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621688004312"><span class="hs-identifier hs-var">pollerLastState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState -&gt; PollerResponseState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSError"><span class="hs-identifier hs-var">PRSError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>                    </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span>
</span><span id="line-491"></span><span>                    </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveLiveQueryPollersInError"><span class="hs-identifier hs-var">submActiveLiveQueryPollersInError</span></a></span><span>
</span><span id="line-492"></span><span>                    </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004265"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-493"></span><span>                  </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveLiveQueryPollers"><span class="hs-identifier hs-var">submActiveLiveQueryPollers</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004265"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-494"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004316"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004316"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004265"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-495"></span><span>                  </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-496"></span><span>                    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004271"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-497"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-498"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004316"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004304"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004316"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004305"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>              </span><span class="hs-comment">-- This would seem to imply addLiveQuery broke or a bug</span><span>
</span><span id="line-501"></span><span>              </span><span class="hs-comment">-- elsewhere. Be paranoid and log:</span><span>
</span><span id="line-502"></span><span>              </span><span class="annot"><span class="annottext">Maybe Thread
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004263"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-504"></span><span>                  </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; IO ()) -&gt; UnstructuredLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span>
</span><span id="line-505"></span><span>                  </span><span class="annot"><span class="annottext">(SerializableBlob -&gt; UnstructuredLog)
-&gt; SerializableBlob -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; SerializableBlob
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-506"></span><span>                  </span><span class="annot"><span class="annottext">(String -&gt; SerializableBlob) -&gt; String -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In removeLiveQuery no worker thread installed. Please report this as a bug: &quot;</span></span><span>
</span><span id="line-507"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LiveQuerySubscriberDetails -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">LiveQuerySubscriberDetails
</span><a href="#local-6989586621688004267"><span class="hs-identifier hs-var">lqId</span></a></span><span>
</span><span id="line-508"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004321"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004321"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004265"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-510"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-511"></span><span>            </span><span class="annot"><span class="annottext">(IO () -&gt; STM (IO ())) -&gt; IO () -&gt; STM (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-512"></span><span>              </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004271"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-513"></span><span>              </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-514"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004321"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004304"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004321"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004305"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeStreamingQuery"><span class="hs-identifier hs-type">removeStreamingQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-518"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-519"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><a href="Hasura.Server.Prometheus.html#PrometheusMetrics"><span class="hs-identifier hs-type">PrometheusMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriptionsState"><span class="hs-identifier hs-type">SubscriptionsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-comment">-- the query and the associated operation</span><span>
</span><span id="line-523"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#StreamingSubscriberDetails"><span class="hs-identifier hs-type">StreamingSubscriberDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#GranularPrometheusMetricsState"><span class="hs-identifier hs-type">GranularPrometheusMetricsState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span id="removeStreamingQuery"><span class="annot"><span class="annottext">removeStreamingQuery :: Logger Hasura
-&gt; ServerMetrics
-&gt; PrometheusMetrics
-&gt; SubscriptionsState
-&gt; StreamingSubscriberDetails
-&gt; IO GranularPrometheusMetricsState
-&gt; Maybe OperationName
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeStreamingQuery"><span class="hs-identifier hs-var hs-var">removeStreamingQuery</span></a></span></span><span> </span><span id="local-6989586621688004322"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004322"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688004323"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004323"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688004324"><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004324"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span></span><span> </span><span id="local-6989586621688004325"><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004325"><span class="hs-identifier hs-var">subscriptionState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#SubscriberDetails"><span class="hs-identifier hs-type">SubscriberDetails</span></a></span><span> </span><span id="local-6989586621688004326"><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004326"><span class="hs-identifier hs-var">handlerId</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688004327"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004327"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004328"><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004328"><span class="hs-identifier hs-var">cursorVariableTV</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004329"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004329"><span class="hs-identifier hs-var">sinkId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004330"><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004330"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span></span><span> </span><span id="local-6989586621688004331"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004331"><span class="hs-identifier hs-var">maybeOperationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><span class="annottext">IO (IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span>
</span><span id="line-529"></span><span>    </span><span class="annot"><span class="annottext">(IO (IO ()) -&gt; IO ()) -&gt; IO (IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM (IO ()) -&gt; IO (IO ())
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><span class="annottext">(STM (IO ()) -&gt; IO (IO ())) -&gt; STM (IO ()) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>      </span><span id="local-6989586621688004332"><span class="annot"><span class="annottext">Maybe
  (Poller (TVar CursorVariableValues), CohortVariables,
   Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621688004332"><span class="hs-identifier hs-var">detM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
</span><a href="#local-6989586621688004333"><span class="hs-identifier hs-var">getQueryDet</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004334"><span class="hs-identifier hs-var">streamQMap</span></a></span><span>
</span><span id="line-532"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (Poller (TVar CursorVariableValues), CohortVariables,
   Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621688004332"><span class="hs-identifier hs-var">detM</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">Maybe
  (Poller (TVar CursorVariableValues), CohortVariables,
   Cohort (TVar CursorVariableValues))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span id="local-6989586621688004335"><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004335"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span id="local-6989586621688004336"><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004336"><span class="hs-identifier hs-var">pollerState</span></a></span></span><span> </span><span id="local-6989586621688004337"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004337"><span class="hs-identifier hs-var">ioState</span></a></span></span><span> </span><span id="local-6989586621688004338"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004338"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621688004339"><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004339"><span class="hs-identifier hs-var">operationNamesMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004340"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004340"><span class="hs-identifier hs-var">currentCohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004341"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004341"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>          </span><span class="annot"><span class="annottext">Maybe OperationName
-&gt; TMap (Maybe OperationName) Int -&gt; STM (Maybe Int)
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004331"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004339"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe Int) -&gt; (Maybe Int -&gt; STM ()) -&gt; STM ()
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-comment">-- If only one operation name is present in the map, delete it</span><span>
</span><span id="line-537"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004331"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004339"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-538"></span><span>            </span><span class="hs-comment">-- If the count of a operation name is more than 1, then it means there</span><span>
</span><span id="line-539"></span><span>            </span><span class="hs-comment">-- are more subscriptions with the same name and we should keep emitting</span><span>
</span><span id="line-540"></span><span>            </span><span class="hs-comment">-- the metrics until the all the subscription with the operaion name are</span><span>
</span><span id="line-541"></span><span>            </span><span class="hs-comment">-- removed</span><span>
</span><span id="line-542"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int)
-&gt; Maybe OperationName -&gt; TMap (Maybe OperationName) Int -&gt; STM ()
forall k v. Hashable k =&gt; (v -&gt; v) -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#adjust"><span class="hs-identifier hs-var">TMap.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688004342"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688004342"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688004342"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004331"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span> </span><span class="annot"><span class="annottext">TMap (Maybe OperationName) Int
</span><a href="#local-6989586621688004339"><span class="hs-identifier hs-var">operationNamesMap</span></a></span><span>
</span><span id="line-543"></span><span>            </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>          </span><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; (Cohort (TVar CursorVariableValues), CohortVariables)
-&gt; ParameterizedQueryHash
-&gt; STM (IO ())
</span><a href="#local-6989586621688004343"><span class="hs-identifier hs-var">cleanHandlerC</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004335"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004336"><span class="hs-identifier hs-var">pollerState</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004337"><span class="hs-identifier hs-var">ioState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004341"><span class="hs-identifier hs-var">cohort</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004340"><span class="hs-identifier hs-var">currentCohortId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004338"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-545"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004323"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/ekg-core-0.1.1.7-06012a11b777bc09e40aa53fadcaf2cf3ff24b6963c248e1bf14879de98aff1f/share/doc/html/src/System.Metrics.Gauge.html#dec"><span class="hs-identifier hs-var">EKG.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveStreamingSubscriptions"><span class="hs-identifier hs-var">smActiveStreamingSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688004323"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-549"></span><span>    </span><span id="local-6989586621688004334"><span class="annot"><span class="annottext">streamQMap :: PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004334"><span class="hs-identifier hs-var hs-var">streamQMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionsState -&gt; PollerMap (TVar CursorVariableValues)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_ssStreamQueryMap"><span class="hs-identifier hs-var">_ssStreamQueryMap</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionsState
</span><a href="#local-6989586621688004325"><span class="hs-identifier hs-var">subscriptionState</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span>    </span><span id="local-6989586621688004333"><span class="annot"><span class="annottext">getQueryDet :: PollerMap (TVar CursorVariableValues)
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
</span><a href="#local-6989586621688004333"><span class="hs-identifier hs-var hs-var">getQueryDet</span></a></span></span><span> </span><span id="local-6989586621688004344"><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004344"><span class="hs-identifier hs-var">subMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-552"></span><span>      </span><span id="local-6989586621688004345"><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
</span><a href="#local-6989586621688004345"><span class="hs-identifier hs-var">pollerM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
-&gt; PollerMap (TVar CursorVariableValues)
-&gt; STM (Maybe (Poller (TVar CursorVariableValues)))
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM (Maybe value)
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#lookup"><span class="hs-identifier hs-var">STMMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004326"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004344"><span class="hs-identifier hs-var">subMap</span></a></span><span>
</span><span id="line-553"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#CursorVariableValues"><span class="hs-identifier hs-type">CursorVariableValues</span></a></span><span> </span><span id="local-6989586621688004346"><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621688004346"><span class="hs-identifier hs-var">currentCohortCursorVal</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues -&gt; STM CursorVariableValues
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar CursorVariableValues
</span><a href="#local-6989586621688004328"><span class="hs-identifier hs-var">cursorVariableTV</span></a></span><span>
</span><span id="line-554"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004348"><span class="annot"><span class="annottext">updatedCohortId :: CohortVariables
</span><a href="#local-6989586621688004348"><span class="hs-identifier hs-var hs-var">updatedCohortId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedVariables (HashMap Name)
-&gt; CohortVariables -&gt; CohortVariables
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#modifyCursorCohortVariables"><span class="hs-identifier hs-var">modifyCursorCohortVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal -&gt; ValidatedVariables (HashMap Name)
forall (f :: * -&gt; *). f TxtEncodedVal -&gt; ValidatedVariables f
</span><a href="Hasura.GraphQL.Execute.Subscription.Plan.html#mkUnsafeValidateVariables"><span class="hs-identifier hs-var">mkUnsafeValidateVariables</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Name TxtEncodedVal
</span><a href="#local-6989586621688004346"><span class="hs-identifier hs-var">currentCohortCursorVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004327"><span class="hs-identifier hs-var">cohortId</span></a></span><span>
</span><span id="line-555"></span><span>      </span><span class="annot"><span class="annottext">(Maybe
   (Maybe
      (Poller (TVar CursorVariableValues), CohortVariables,
       Cohort (TVar CursorVariableValues)))
 -&gt; Maybe
      (Poller (TVar CursorVariableValues), CohortVariables,
       Cohort (TVar CursorVariableValues)))
-&gt; STM
     (Maybe
        (Maybe
           (Poller (TVar CursorVariableValues), CohortVariables,
            Cohort (TVar CursorVariableValues))))
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
forall a b. (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe
  (Maybe
     (Poller (TVar CursorVariableValues), CohortVariables,
      Cohort (TVar CursorVariableValues)))
-&gt; Maybe
     (Poller (TVar CursorVariableValues), CohortVariables,
      Cohort (TVar CursorVariableValues))
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span>
</span><span id="line-556"></span><span>        </span><span class="annot"><span class="annottext">(STM
   (Maybe
      (Maybe
         (Poller (TVar CursorVariableValues), CohortVariables,
          Cohort (TVar CursorVariableValues))))
 -&gt; STM
      (Maybe
         (Poller (TVar CursorVariableValues), CohortVariables,
          Cohort (TVar CursorVariableValues))))
-&gt; STM
     (Maybe
        (Maybe
           (Poller (TVar CursorVariableValues), CohortVariables,
            Cohort (TVar CursorVariableValues))))
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
-&gt; (Poller (TVar CursorVariableValues)
    -&gt; STM
         (Maybe
            (Poller (TVar CursorVariableValues), CohortVariables,
             Cohort (TVar CursorVariableValues))))
-&gt; STM
     (Maybe
        (Maybe
           (Poller (TVar CursorVariableValues), CohortVariables,
            Cohort (TVar CursorVariableValues))))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller (TVar CursorVariableValues))
</span><a href="#local-6989586621688004345"><span class="hs-identifier hs-var">pollerM</span></a></span><span>
</span><span id="line-557"></span><span>        </span><span class="annot"><span class="annottext">((Poller (TVar CursorVariableValues)
  -&gt; STM
       (Maybe
          (Poller (TVar CursorVariableValues), CohortVariables,
           Cohort (TVar CursorVariableValues))))
 -&gt; STM
      (Maybe
         (Maybe
            (Poller (TVar CursorVariableValues), CohortVariables,
             Cohort (TVar CursorVariableValues)))))
-&gt; (Poller (TVar CursorVariableValues)
    -&gt; STM
         (Maybe
            (Poller (TVar CursorVariableValues), CohortVariables,
             Cohort (TVar CursorVariableValues))))
-&gt; STM
     (Maybe
        (Maybe
           (Poller (TVar CursorVariableValues), CohortVariables,
            Cohort (TVar CursorVariableValues))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688004351"><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004351"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>          </span><span id="local-6989586621688004352"><span class="annot"><span class="annottext">Maybe (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621688004352"><span class="hs-identifier hs-var">cohortM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortVariables
-&gt; CohortMap (TVar CursorVariableValues)
-&gt; STM (Maybe (Cohort (TVar CursorVariableValues)))
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004348"><span class="hs-identifier hs-var">updatedCohortId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
-&gt; CohortMap (TVar CursorVariableValues)
forall streamCursor. Poller streamCursor -&gt; CohortMap streamCursor
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pCohorts"><span class="hs-identifier hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004351"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>          </span><span class="annot"><span class="annottext">Maybe
  (Poller (TVar CursorVariableValues), CohortVariables,
   Cohort (TVar CursorVariableValues))
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe
   (Poller (TVar CursorVariableValues), CohortVariables,
    Cohort (TVar CursorVariableValues))
 -&gt; STM
      (Maybe
         (Poller (TVar CursorVariableValues), CohortVariables,
          Cohort (TVar CursorVariableValues))))
-&gt; Maybe
     (Poller (TVar CursorVariableValues), CohortVariables,
      Cohort (TVar CursorVariableValues))
-&gt; STM
     (Maybe
        (Poller (TVar CursorVariableValues), CohortVariables,
         Cohort (TVar CursorVariableValues)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller (TVar CursorVariableValues)
</span><a href="#local-6989586621688004351"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004348"><span class="hs-identifier hs-var">updatedCohortId</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Cohort (TVar CursorVariableValues)
 -&gt; (Poller (TVar CursorVariableValues), CohortVariables,
     Cohort (TVar CursorVariableValues)))
-&gt; Maybe (Cohort (TVar CursorVariableValues))
-&gt; Maybe
     (Poller (TVar CursorVariableValues), CohortVariables,
      Cohort (TVar CursorVariableValues))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Cohort (TVar CursorVariableValues))
</span><a href="#local-6989586621688004352"><span class="hs-identifier hs-var">cohortM</span></a></span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621688004343"><span class="annot"><span class="annottext">cleanHandlerC :: CohortMap (TVar CursorVariableValues)
-&gt; TVar PollerResponseState
-&gt; TMVar PollerIOState
-&gt; (Cohort (TVar CursorVariableValues), CohortVariables)
-&gt; ParameterizedQueryHash
-&gt; STM (IO ())
</span><a href="#local-6989586621688004343"><span class="hs-identifier hs-var hs-var">cleanHandlerC</span></a></span></span><span> </span><span id="local-6989586621688004353"><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004353"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621688004354"><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004354"><span class="hs-identifier hs-var">pollerState</span></a></span></span><span> </span><span id="local-6989586621688004355"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004355"><span class="hs-identifier hs-var">ioState</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688004356"><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004356"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688004357"><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004357"><span class="hs-identifier hs-var">currentCohortId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688004358"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004358"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004359"><span class="annot"><span class="annottext">curOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004359"><span class="hs-identifier hs-var hs-var">curOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cExistingSubscribers"><span class="hs-identifier hs-var">_cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004356"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-563"></span><span>          </span><span id="local-6989586621688004360"><span class="annot"><span class="annottext">newOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004360"><span class="hs-identifier hs-var hs-var">newOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues) -&gt; TMap SubscriberId Subscriber
forall streamCursorVars.
Cohort streamCursorVars -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_cNewSubscribers"><span class="hs-identifier hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort (TVar CursorVariableValues)
</span><a href="#local-6989586621688004356"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-564"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004329"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004359"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-565"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004329"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004360"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-566"></span><span>      </span><span id="local-6989586621688004361"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004361"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-567"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">(&amp;&amp;)</span></span><span>
</span><span id="line-568"></span><span>          </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool) -&gt; STM Bool -&gt; STM (Bool -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004359"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-569"></span><span>          </span><span class="annot"><span class="annottext">STM (Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688004360"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-570"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004361"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables -&gt; CohortMap (TVar CursorVariableValues) -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004357"><span class="hs-identifier hs-var">currentCohortId</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004353"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-571"></span><span>      </span><span id="local-6989586621688004362"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004362"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues) -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004353"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-572"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004363"><span class="annot"><span class="annottext">promMetricGranularLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004363"><span class="hs-identifier hs-var hs-var">promMetricGranularLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#streamingSubscriptionLabel"><span class="hs-identifier hs-var">streamingSubscriptionLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicGraphqlOperationLabel -&gt; Maybe DynamicGraphqlOperationLabel
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DynamicGraphqlOperationLabel
 -&gt; Maybe DynamicGraphqlOperationLabel)
-&gt; DynamicGraphqlOperationLabel
-&gt; Maybe DynamicGraphqlOperationLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ParameterizedQueryHash
-&gt; Maybe OperationName -&gt; DynamicGraphqlOperationLabel
</span><a href="Hasura.Server.Prometheus.html#DynamicGraphqlOperationLabel"><span class="hs-identifier hs-var">DynamicGraphqlOperationLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParameterizedQueryHash -&gt; Maybe ParameterizedQueryHash
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688004358"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688004331"><span class="hs-identifier hs-var">maybeOperationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>          </span><span id="local-6989586621688004364"><span class="annot"><span class="annottext">promMetricLabel :: SubscriptionLabel
</span><a href="#local-6989586621688004364"><span class="hs-identifier hs-var hs-var">promMetricLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
-&gt; Maybe DynamicGraphqlOperationLabel -&gt; SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#SubscriptionLabel"><span class="hs-identifier hs-var">SubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionKindLabel
</span><a href="Hasura.Server.Prometheus.html#streamingSubscriptionLabel"><span class="hs-identifier hs-var">streamingSubscriptionLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DynamicGraphqlOperationLabel
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-574"></span><span>      </span><span class="hs-comment">-- when there is no need for handler i.e,</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-comment">-- operation, take the ref for the polling thread to cancel it</span><span>
</span><span id="line-576"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688004362"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span><span>
</span><span id="line-577"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>          </span><span class="annot"><span class="annottext">BackendPollerKey -&gt; PollerMap (TVar CursorVariableValues) -&gt; STM ()
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/stm-containers-1.2-b69fadc81478b9a6a5d56f01a2394fd5db61dec0fbf306b965c731a41523f0e2/share/doc/html/src/StmContainers.Map.html#delete"><span class="hs-identifier hs-var">STMMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004326"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap (TVar CursorVariableValues)
</span><a href="#local-6989586621688004334"><span class="hs-identifier hs-var">streamQMap</span></a></span><span>
</span><span id="line-579"></span><span>          </span><span id="local-6989586621688004365"><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688004365"><span class="hs-identifier hs-var">threadRefM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PollerIOState -&gt; Thread) -&gt; Maybe PollerIOState -&gt; Maybe Thread
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PollerIOState -&gt; Thread
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#_pThread"><span class="hs-identifier hs-var">_pThread</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PollerIOState -&gt; Maybe Thread)
-&gt; STM (Maybe PollerIOState) -&gt; STM (Maybe Thread)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; STM (Maybe PollerIOState)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">STM.tryReadTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688004355"><span class="hs-identifier hs-var">ioState</span></a></span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-581"></span><span>            </span><span class="annot"><span class="annottext">(IO () -&gt; STM (IO ())) -&gt; IO () -&gt; STM (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-582"></span><span>            </span><span class="hs-comment">-- deferred IO:</span><span>
</span><span id="line-583"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688004365"><span class="hs-identifier hs-var">threadRefM</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-584"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688004366"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004366"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-585"></span><span>                </span><span class="annot"><span class="annottext">Thread -&gt; IO ()
</span><a href="file:///root/.local/state/cabal/store/ghc-9.4.5/immortal-0.2.2.1-e3bd4e0e64dc114baa3abc247b1e60df834aa7935cf82aff7a3976b9f7bb0e91/share/doc/html/src/Control.Immortal.html#stop"><span class="hs-identifier hs-var">Immortal.stop</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688004366"><span class="hs-identifier hs-var">threadRef</span></a></span><span>
</span><span id="line-586"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-587"></span><span>                  </span><span id="local-6989586621688004367"><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621688004367"><span class="hs-identifier hs-var">pollerLastState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState -&gt; IO PollerResponseState
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar PollerResponseState
</span><a href="#local-6989586621688004354"><span class="hs-identifier hs-var">pollerState</span></a></span><span>
</span><span id="line-588"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="#local-6989586621688004367"><span class="hs-identifier hs-var">pollerLastState</span></a></span><span> </span><span class="annot"><span class="annottext">PollerResponseState -&gt; PollerResponseState -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PollerResponseState
</span><a href="Hasura.GraphQL.Execute.Subscription.Poll.Common.html#PRSError"><span class="hs-identifier hs-var">PRSError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>                    </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span>
</span><span id="line-590"></span><span>                    </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveStreamingPollersInError"><span class="hs-identifier hs-var">submActiveStreamingPollersInError</span></a></span><span>
</span><span id="line-591"></span><span>                    </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004324"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-592"></span><span>                  </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.Gauge.html#dec"><span class="hs-identifier hs-var">Prometheus.Gauge.dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; Gauge
</span><a href="Hasura.Server.Prometheus.html#submActiveStreamingPollers"><span class="hs-identifier hs-var">submActiveStreamingPollers</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; Gauge) -&gt; SubscriptionMetrics -&gt; Gauge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004324"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-593"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004369"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004369"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004324"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-594"></span><span>                  </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-595"></span><span>                    </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004330"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-596"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-597"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004369"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004363"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004369"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004364"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>              </span><span class="hs-comment">-- This would seem to imply addStreamSubscriptionQuery broke or a bug</span><span>
</span><span id="line-600"></span><span>              </span><span class="hs-comment">-- elsewhere. Be paranoid and log:</span><span>
</span><span id="line-601"></span><span>              </span><span class="annot"><span class="annottext">Maybe Thread
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-602"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688004322"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-603"></span><span>                  </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; IO ()) -&gt; UnstructuredLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; SerializableBlob -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span>
</span><span id="line-604"></span><span>                  </span><span class="annot"><span class="annottext">(SerializableBlob -&gt; UnstructuredLog)
-&gt; SerializableBlob -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; SerializableBlob
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-605"></span><span>                  </span><span class="annot"><span class="annottext">(String -&gt; SerializableBlob) -&gt; String -&gt; SerializableBlob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In removeStreamingQuery no worker thread installed. Please report this as a bug: &quot;</span></span><span>
</span><span id="line-606"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; poller_id: &quot;</span></span><span>
</span><span id="line-607"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BackendPollerKey
</span><a href="#local-6989586621688004326"><span class="hs-identifier hs-var">handlerId</span></a></span><span>
</span><span id="line-608"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, cohort_id: &quot;</span></span><span>
</span><span id="line-609"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CohortVariables
</span><a href="#local-6989586621688004327"><span class="hs-identifier hs-var">cohortId</span></a></span><span>
</span><span id="line-610"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, subscriber_id:&quot;</span></span><span>
</span><span id="line-611"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubscriberId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688004329"><span class="hs-identifier hs-var">sinkId</span></a></span><span>
</span><span id="line-612"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-613"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688004370"><span class="annot"><span class="annottext">numSubscriptionMetric :: GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004370"><span class="hs-identifier hs-var hs-var">numSubscriptionMetric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
</span><a href="Hasura.Server.Prometheus.html#submActiveSubscriptions"><span class="hs-identifier hs-var">submActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">(SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel)
-&gt; SubscriptionMetrics -&gt; GaugeVector SubscriptionLabel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics -&gt; SubscriptionMetrics
</span><a href="Hasura.Server.Prometheus.html#pmSubscriptionMetrics"><span class="hs-identifier hs-var">pmSubscriptionMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(PrometheusMetrics -&gt; SubscriptionMetrics)
-&gt; PrometheusMetrics -&gt; SubscriptionMetrics
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrometheusMetrics
</span><a href="#local-6989586621688004324"><span class="hs-identifier hs-var">prometheusMetrics</span></a></span><span>
</span><span id="line-614"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; STM (IO ())
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-615"></span><span>            </span><span class="annot"><span class="annottext">(IO () -&gt; STM (IO ())) -&gt; IO () -&gt; STM (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
-&gt; Bool -&gt; IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
IO GranularPrometheusMetricsState -&gt; Bool -&gt; IO () -&gt; IO () -&gt; m ()
</span><a href="Hasura.Server.Prometheus.html#recordMetricWithLabel"><span class="hs-identifier hs-var">recordMetricWithLabel</span></a></span><span>
</span><span id="line-616"></span><span>              </span><span class="annot"><span class="annottext">IO GranularPrometheusMetricsState
</span><a href="#local-6989586621688004330"><span class="hs-identifier hs-var">granularPrometheusMetricsState</span></a></span><span>
</span><span id="line-617"></span><span>              </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-618"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004370"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004363"><span class="hs-identifier hs-var">promMetricGranularLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel -&gt; SubscriptionLabel -&gt; IO ()
forall label. Ord label =&gt; GaugeVector label -&gt; label -&gt; IO ()
</span><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/ekg-prometheus-0.3.0.0/opt/doc/html/ekg-prometheus/src/System.Metrics.Prometheus.GaugeVector.html#dec"><span class="hs-identifier hs-var">GaugeVector.dec</span></a></span><span> </span><span class="annot"><span class="annottext">GaugeVector SubscriptionLabel
</span><a href="#local-6989586621688004370"><span class="hs-identifier hs-var">numSubscriptionMetric</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriptionLabel
</span><a href="#local-6989586621688004364"><span class="hs-identifier hs-var">promMetricLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span class="hs-comment">-- | An async action query whose relationships are referred to table in a source.</span><span>
</span><span id="line-622"></span><span class="hs-comment">-- We need to generate an SQL statement with the action response and execute it</span><span>
</span><span id="line-623"></span><span class="hs-comment">-- in the source database so as to fetch response joined with relationship rows.</span><span>
</span><span id="line-624"></span><span class="hs-comment">-- For more details see Note [Resolving async action query]</span><span>
</span><span id="line-625"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQueryOnSource"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-var">LiveAsyncActionQueryOnSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveAsyncActionQueryOnSource"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-var">LiveAsyncActionQueryOnSource</span></a></span></span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_laaqpCurrentLqId"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource -&gt; LiveQuerySubscriberDetails
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_laaqpCurrentLqId"><span class="hs-identifier hs-var hs-var">_laaqpCurrentLqId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-type">LiveQuerySubscriberDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-627"></span><span>    </span><span id="_laaqpPrevActionLogMap"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource -&gt; ActionLogResponseMap
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_laaqpPrevActionLogMap"><span class="hs-identifier hs-var hs-var">_laaqpPrevActionLogMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-comment">-- | An IO action to restart the live query poller with updated action log responses fetched from metadata storage</span><span>
</span><span id="line-629"></span><span>    </span><span class="hs-comment">-- Restarting a live query re-generates the SQL statement with new action log responses to send latest action</span><span>
</span><span id="line-630"></span><span>    </span><span class="hs-comment">-- response to the client.</span><span>
</span><span id="line-631"></span><span>    </span><span id="_laaqpRestartLq"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource
-&gt; LiveQuerySubscriberDetails
-&gt; ActionLogResponseMap
-&gt; IO (Maybe LiveQuerySubscriberDetails)
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_laaqpRestartLq"><span class="hs-identifier hs-var hs-var">_laaqpRestartLq</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-type">LiveQuerySubscriberDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveQuerySubscriberDetails"><span class="hs-identifier hs-type">LiveQuerySubscriberDetails</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQueryWithNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-var">LiveAsyncActionQueryWithNoRelationships</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveAsyncActionQueryWithNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-var">LiveAsyncActionQueryWithNoRelationships</span></a></span></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-comment">-- | An IO action to send response to the websocket client</span></span><span>
</span><span id="line-636"></span><span>    </span><span id="_laaqwnrSendResponse"><span class="annot"><span class="annottext">LiveAsyncActionQueryWithNoRelationships
-&gt; ActionLogResponseMap -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_laaqwnrSendResponse"><span class="hs-identifier hs-var hs-var">_laaqwnrSendResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><span class="hs-comment">-- | An IO action to send &quot;completed&quot; message to the websocket client</span></span><span>
</span><span id="line-638"></span><span>    </span><span id="_laaqwnrSendCompleted"><span class="annot"><span class="annottext">LiveAsyncActionQueryWithNoRelationships -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_laaqwnrSendCompleted"><span class="hs-identifier hs-var hs-var">_laaqwnrSendCompleted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQuery"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-var">LiveAsyncActionQuery</span></a></span></span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="LAAQNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LAAQNoRelationships"><span class="hs-identifier hs-var">LAAQNoRelationships</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-type">LiveAsyncActionQueryWithNoRelationships</span></a></span><span>
</span><span id="line-643"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LAAQOnSourceDB"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LAAQOnSourceDB"><span class="hs-identifier hs-var">LAAQOnSourceDB</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-type">LiveAsyncActionQueryOnSource</span></a></span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span class="hs-keyword">data</span><span> </span><span id="AsyncActionQueryLive"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AsyncActionQueryLive"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span></span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_aaqlActionIds"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; NonEmpty ActionId
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_aaqlActionIds"><span class="hs-identifier hs-var hs-var">_aaqlActionIds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionId"><span class="hs-identifier hs-type">ActionId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-647"></span><span>    </span><span class="annot"><span class="hs-comment">-- | An IO action to send error message (in case of any exception) to the websocket client</span></span><span>
</span><span id="line-648"></span><span>    </span><span id="_aaqlOnException"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; QErr -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_aaqlOnException"><span class="hs-identifier hs-var hs-var">_aaqlOnException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-649"></span><span>    </span><span id="_aaqlLiveExecution"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; LiveAsyncActionQuery
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#_aaqlLiveExecution"><span class="hs-identifier hs-var hs-var">_aaqlLiveExecution</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-type">LiveAsyncActionQuery</span></a></span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span class="annot"><span class="hs-comment">-- | A share-able state map which stores an async action live query with it's subscription operation id</span></span><span>
</span><span id="line-653"></span><span class="hs-keyword">type</span><span> </span><span id="AsyncActionSubscriptionState"><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-var">AsyncActionSubscriptionState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-type">AsyncActionQueryLive</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#addAsyncActionLiveQuery"><span class="hs-identifier hs-type">addAsyncActionLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-656"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-658"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionId"><span class="hs-identifier hs-type">ActionId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="file:///workdir/dist-newstyle/build/x86_64-linux/ghc-9.4.5/hasura-base-1.0.0/opt/doc/html/hasura-base/src/Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-660"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-type">LiveAsyncActionQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span id="addAsyncActionLiveQuery"><span class="annot"><span class="annottext">addAsyncActionLiveQuery :: AsyncActionSubscriptionState
-&gt; OperationId
-&gt; NonEmpty ActionId
-&gt; (QErr -&gt; IO ())
-&gt; LiveAsyncActionQuery
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#addAsyncActionLiveQuery"><span class="hs-identifier hs-var hs-var">addAsyncActionLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688004384"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688004384"><span class="hs-identifier hs-var">queriesState</span></a></span></span><span> </span><span id="local-6989586621688004385"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688004385"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span id="local-6989586621688004386"><span class="annot"><span class="annottext">NonEmpty ActionId
</span><a href="#local-6989586621688004386"><span class="hs-identifier hs-var">actionIds</span></a></span></span><span> </span><span id="local-6989586621688004387"><span class="annot"><span class="annottext">QErr -&gt; IO ()
</span><a href="#local-6989586621688004387"><span class="hs-identifier hs-var">onException</span></a></span></span><span> </span><span id="local-6989586621688004388"><span class="annot"><span class="annottext">LiveAsyncActionQuery
</span><a href="#local-6989586621688004388"><span class="hs-identifier hs-var">liveQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-663"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AsyncActionQueryLive
-&gt; OperationId -&gt; AsyncActionSubscriptionState -&gt; STM ()
forall k v. Hashable k =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty ActionId
-&gt; (QErr -&gt; IO ()) -&gt; LiveAsyncActionQuery -&gt; AsyncActionQueryLive
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ActionId
</span><a href="#local-6989586621688004386"><span class="hs-identifier hs-var">actionIds</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; IO ()
</span><a href="#local-6989586621688004387"><span class="hs-identifier hs-var">onException</span></a></span><span> </span><span class="annot"><span class="annottext">LiveAsyncActionQuery
</span><a href="#local-6989586621688004388"><span class="hs-identifier hs-var">liveQuery</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688004385"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688004384"><span class="hs-identifier hs-var">queriesState</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier hs-type">removeAsyncActionLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Subscription.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span id="removeAsyncActionLiveQuery"><span class="annot"><span class="annottext">removeAsyncActionLiveQuery :: AsyncActionSubscriptionState -&gt; OperationId -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.Subscription.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier hs-var hs-var">removeAsyncActionLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688004389"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688004389"><span class="hs-identifier hs-var">queriesState</span></a></span></span><span> </span><span id="local-6989586621688004390"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688004390"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-669"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OperationId -&gt; AsyncActionSubscriptionState -&gt; STM ()
forall k v. Hashable k =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.Subscription.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688004390"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688004389"><span class="hs-identifier hs-var">queriesState</span></a></span><span>
</span><span id="line-670"></span></pre></body></html>